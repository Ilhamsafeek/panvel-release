{% extends "base.html" %}

{% block title %}Select Your Package - PanvelIQ{% endblock %}

{% block extra_css %}
<style>
    :root {
        --primary-purple: #9926F3;
        --primary-cyan: #1DD8FC;
        --gradient: linear-gradient(135deg, #9926F3 0%, #1DD8FC 100%);
        --color-gray-50: #F9FAFB;
        --color-gray-100: #F3F4F6;
        --color-gray-200: #E5E7EB;
        --color-gray-300: #D1D5DB;
        --color-gray-600: #4B5563;
        --color-gray-700: #374151;
        --color-gray-900: #111827;
        --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }

    body {
        font-family: 'Gilroy', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        background: var(--color-gray-50);
        margin: 0;
        padding: 0;
    }

    /* =====================================================
       HEADER SECTION
       ===================================================== */
    .onboarding-header {
        text-align: center;
        padding: 3rem 1rem 2rem;
        background: white;
        border-bottom: 1px solid var(--color-gray-200);
    }

    .header-logo {
        margin-bottom: 1.5rem;
    }

    .header-logo img {
        height: 50px;
    }

    .onboarding-header h1 {
        font-size: 2rem;
        font-weight: 700;
        background: var(--gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin: 0 0 0.5rem 0;
    }

    .onboarding-header p {
        font-size: 1.125rem;
        color: var(--color-gray-600);
        margin: 0;
        max-width: 600px;
        margin-left: auto;
        margin-right: auto;
    }

    /* =====================================================
       PACKAGE SELECTION CONTAINER
       ===================================================== */
    .packages-container {
        max-width: 1200px;
        margin: 3rem auto;
        padding: 0 1rem 3rem;
    }

    .packages-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 2rem;
        margin-top: 2rem;
    }

    /* =====================================================
       PACKAGE CARD
       ===================================================== */
    .package-card {
        background: white;
        border-radius: 16px;
        padding: 2rem;
        box-shadow: var(--shadow-md);
        border: 2px solid transparent;
        transition: all 0.3s ease;
        position: relative;
        display: flex;
        flex-direction: column;
    }

    .package-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-lg);
    }

    .package-card.recommended {
        border-color: var(--primary-purple);
        box-shadow: 0 0 0 4px rgba(153, 38, 243, 0.1);
    }

    .recommended-badge {
        position: absolute;
        top: -12px;
        right: 20px;
        background: var(--gradient);
        color: white;
        padding: 0.375rem 1rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .package-tier {
        display: inline-block;
        background: var(--color-gray-100);
        color: var(--color-gray-700);
        padding: 0.375rem 0.875rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 1rem;
    }

    .package-card.recommended .package-tier {
        background: var(--gradient);
        color: white;
    }

    .package-name {
        font-size: 1.75rem;
        font-weight: 700;
        color: var(--color-gray-900);
        margin: 0.5rem 0 1rem;
    }

    .package-description {
        font-size: 0.875rem;
        color: var(--color-gray-600);
        line-height: 1.6;
        margin-bottom: 1.5rem;
    }

    .package-price {
        display: flex;
        align-items: baseline;
        gap: 0.5rem;
        margin-bottom: 1.5rem;
        padding-bottom: 1.5rem;
        border-bottom: 1px solid var(--color-gray-200);
    }

    .price-amount {
        font-size: 2.5rem;
        font-weight: 700;
        background: var(--gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .price-currency {
        font-size: 1.5rem;
        font-weight: 700;
        background: var(--gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .price-period {
        font-size: 1rem;
        color: var(--color-gray-600);
    }

    .package-features {
        list-style: none;
        padding: 0;
        margin: 0 0 2rem 0;
        flex-grow: 1;
    }

    .package-features li {
        display: flex;
        align-items: flex-start;
        gap: 0.75rem;
        margin-bottom: 0.875rem;
        font-size: 0.9375rem;
        color: var(--color-gray-700);
    }

    .package-features li i {
        color: var(--primary-purple);
        font-size: 1.25rem;
        flex-shrink: 0;
        margin-top: 2px;
    }

    .select-package-btn {
        width: 100%;
        background: var(--gradient);
        color: white;
        border: none;
        padding: 1rem;
        border-radius: 10px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }

    .select-package-btn:hover {
        transform: scale(1.02);
        box-shadow: 0 8px 20px rgba(153, 38, 243, 0.3);
    }

    .select-package-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    .select-package-btn.loading {
        opacity: 0.7;
        cursor: wait;
    }

    .btn-spinner {
        width: 18px;
        height: 18px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-top-color: white;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        display: none;
    }

    .select-package-btn.loading .btn-spinner {
        display: block;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* =====================================================
       RESPONSIVE
       ===================================================== */
    @media (max-width: 768px) {
        .packages-grid {
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }

        .onboarding-header h1 {
            font-size: 1.75rem;
        }

        .onboarding-header p {
            font-size: 1rem;
        }

        .package-name {
            font-size: 1.5rem;
        }

        .price-amount {
            font-size: 2rem;
        }
    }

    /* =====================================================
       ALERT MESSAGES
       ===================================================== */
    .alert {
        padding: 1rem 1.5rem;
        border-radius: 10px;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-size: 0.9375rem;
    }

    .alert-success {
        background: #D1FAE5;
        color: #065F46;
        border: 1px solid #6EE7B7;
    }

    .alert-error {
        background: #FEE2E2;
        color: #991B1B;
        border: 1px solid #FCA5A5;
    }

    .alert i {
        font-size: 1.25rem;
    }

    /* =====================================================
       LOADING STATE
       ===================================================== */
    .loading-container {
        text-align: center;
        padding: 4rem 1rem;
    }

    .loader {
        width: 60px;
        height: 60px;
        border: 5px solid var(--color-gray-200);
        border-top-color: var(--primary-purple);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 1.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="onboarding-header">
    <div class="header-logo">
        <img src="{{ url_for('static', path='images/panvel-logo.webp') }}" alt="PanvelIQ">
    </div>
    <h1>Choose Your Package</h1>
    <p>Select the perfect plan to accelerate your digital marketing success</p>
</div>

<div class="packages-container">
    <div id="alertContainer"></div>
    
    <div id="loadingState" class="loading-container" style="display: none;">
        <div class="loader"></div>
        <p style="color: var(--color-gray-600); font-weight: 600;">Loading packages...</p>
    </div>

    <div id="packagesGrid" class="packages-grid">
        <!-- Packages will be loaded dynamically -->
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    loadPackages();
});

async function loadPackages() {
    const loadingState = document.getElementById('loadingState');
    const packagesGrid = document.getElementById('packagesGrid');
    const alertContainer = document.getElementById('alertContainer');
    
    loadingState.style.display = 'block';
    packagesGrid.style.display = 'none';
    
    try {
        const response = await fetch(`${APP_CONFIG.apiBaseUrl}/onboarding/packages`, {
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('access_token')}`
            }
        });
        
        if (!response.ok) {
            throw new Error('Failed to load packages');
        }
        
        const data = await response.json();
        
        if (data.status === 'success' && data.packages && data.packages.length > 0) {
            renderPackages(data.packages);
            loadingState.style.display = 'none';
            packagesGrid.style.display = 'grid';
        } else {
            showAlert('No packages available at the moment', 'error');
        }
        
    } catch (error) {
        console.error('Error loading packages:', error);
        showAlert('Failed to load packages. Please try again.', 'error');
        loadingState.style.display = 'none';
    }
}

function renderPackages(packages) {
    const packagesGrid = document.getElementById('packagesGrid');
    packagesGrid.innerHTML = '';
    
    packages.forEach((pkg, index) => {
        const isRecommended = pkg.package_tier === 'professional';
        
        const card = document.createElement('div');
        card.className = `package-card ${isRecommended ? 'recommended' : ''}`;
        
        card.innerHTML = `
            ${isRecommended ? '<div class="recommended-badge">Recommended</div>' : ''}
            
            <div class="package-tier">${pkg.package_tier}</div>
            
            <h2 class="package-name">${pkg.package_name}</h2>
            
            <p class="package-description">${pkg.description || ''}</p>
            
            <div class="package-price">
                <span class="price-currency">â‚¹</span>
                <span class="price-amount">${parseFloat(pkg.price).toFixed(0)}</span>
                <span class="price-period">/${pkg.billing_cycle}</span>
            </div>
            
            <ul class="package-features">
                ${renderFeatures(pkg.features)}
            </ul>
            
            <button class="select-package-btn" onclick="selectPackage(${pkg.package_id}, '${pkg.package_name}')">
                <span class="btn-spinner"></span>
                <i class="ti ti-check"></i>
                Select ${pkg.package_name}
            </button>
        `;
        
        packagesGrid.appendChild(card);
    });
}

function renderFeatures(features) {
    if (!features || typeof features !== 'object') {
        return '<li><i class="ti ti-check"></i><span>All essential features included</span></li>';
    }
    
    let featuresHtml = '';
    
    if (Array.isArray(features)) {
        features.forEach(feature => {
            featuresHtml += `<li><i class="ti ti-check"></i><span>${feature}</span></li>`;
        });
    } else {
        // If features is an object, iterate through its values
        Object.values(features).forEach(feature => {
            if (typeof feature === 'string') {
                featuresHtml += `<li><i class="ti ti-check"></i><span>${feature}</span></li>`;
            }
        });
    }
    
    return featuresHtml || '<li><i class="ti ti-check"></i><span>All essential features included</span></li>';
}

async function selectPackage(packageId, packageName) {
    const button = event.target.closest('.select-package-btn');
    const allButtons = document.querySelectorAll('.select-package-btn');
    
    // Disable all buttons
    allButtons.forEach(btn => btn.disabled = true);
    button.classList.add('loading');
    
    try {
        const response = await fetch(`${APP_CONFIG.apiBaseUrl}/onboarding/select-package`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${localStorage.getItem('access_token')}`
            },
            body: JSON.stringify({
                package_id: packageId
            })
        });
        
        const data = await response.json();
        
        if (response.ok && data.status === 'success') {
            showAlert(`${packageName} package selected successfully! Redirecting...`, 'success');
            
            // Redirect to verification page after 1.5 seconds
            setTimeout(() => {
                window.location.href = '/onboarding/verification';
            }, 1500);
        } else {
            throw new Error(data.detail || 'Failed to select package');
        }
        
    } catch (error) {
        console.error('Error selecting package:', error);
        showAlert(error.message || 'Failed to select package. Please try again.', 'error');
        
        // Re-enable buttons
        allButtons.forEach(btn => btn.disabled = false);
        button.classList.remove('loading');
    }
}

function showAlert(message, type) {
    const alertContainer = document.getElementById('alertContainer');
    const icon = type === 'success' ? 'ti-check-circle' : 'ti-alert-circle';
    
    const alert = document.createElement('div');
    alert.className = `alert alert-${type}`;
    alert.innerHTML = `
        <i class="ti ${icon}"></i>
        <span>${message}</span>
    `;
    
    alertContainer.innerHTML = '';
    alertContainer.appendChild(alert);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        alert.remove();
    }, 5000);
}
</script>
{% endblock %}