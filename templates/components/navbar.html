<!-- templates/components/sidebar.html -->
<aside class="sidebar" id="sidebar">
    <div class="sidebar-content">
        <!-- Logo (only shown when navbar is NOT present) -->
        <div class="sidebar-logo">
            <a href="/" class="logo">
                <img src="{{ url_for('static', path='images/panvel-logo.webp') }}" alt="PanvelIQ" width="40px">
                <span class="logo-text">PanvelIQ</span>
            </a>
        </div>

        <!-- User Info Section -->
        <div class="sidebar-user">
            <img src="/static/images/default-avatar.png" alt="User" class="sidebar-user-avatar" id="sidebarUserAvatar">
            <div class="sidebar-user-info">
                <h4 id="sidebarUserName">Loading...</h4>
                <p id="sidebarUserRole">-</p>
            </div>
        </div>

        <!-- Navigation Menu -->
        <nav class="sidebar-nav" id="sidebarNav">
            <!-- Will be populated dynamically based on user role -->
        </nav>

        <!-- Sidebar Footer -->
        <div class="sidebar-footer">
            <a href="/help" class="sidebar-footer-link">
                <i class="ti ti-help-circle"></i>
                <span>Help & Support</span>
            </a>
            <a href="#" class="sidebar-footer-link" id="sidebarLogout">
                <i class="ti ti-logout"></i>
                <span>Logout</span>
            </a>
        </div>
    </div>

    <!-- Sidebar Toggle -->
    <button class="sidebar-toggle" id="sidebarToggle">
        <i class="ti ti-chevron-left"></i>
    </button>
</aside>

<style>
    .sidebar {
        position: fixed;
        left: 0;
        top: 0;
        width: 280px;
        height: 100vh;
        background: white;
        border-right: 1px solid var(--color-gray-200);
        z-index: 1001;
        transition: transform 0.3s ease;
        display: flex;
        flex-direction: column;
    }

    /* When both sidebar and navbar are present, adjust sidebar */
    body.has-navbar .sidebar {
        top: 70px;
        height: calc(100vh - 70px);
    }

    /* Hide logo when navbar is present */
    body.has-navbar .sidebar-logo {
        display: none;
    }

    .sidebar.collapsed {
        transform: translateX(-280px);
    }

    .sidebar-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow-y: auto;
        padding-bottom: 1rem;
    }

    /* Logo */
    .sidebar-logo {
        padding: 1.5rem;
        border-bottom: 1px solid var(--color-gray-200);
    }

    .sidebar-logo .logo {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        text-decoration: none;
    }

    .logo-text {
        font-size: 20px;
        font-weight: 700;
        background: var(--gradient-primary);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    /* User Info */
    .sidebar-user {
        padding: 1.25rem;
        border-bottom: 1px solid var(--color-gray-200);
        display: flex;
        align-items: center;
        gap: 0.75rem;
        background: var(--color-gray-50);
    }

    .sidebar-user-avatar {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        border: 2px solid var(--color-gray-200);
    }

    .sidebar-user-info h4 {
        font-size: 15px;
        font-weight: 600;
        color: var(--color-gray-900);
        margin-bottom: 0.25rem;
    }

    .sidebar-user-info p {
        font-size: 13px;
        color: var(--color-gray-600);
        text-transform: capitalize;
    }

    /* Navigation */
    .sidebar-nav {
        flex: 1;
        padding: 1rem 0;
    }

    .nav-section {
        margin-bottom: 1.5rem;
    }

    .nav-section-title {
        padding: 0 1.5rem;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        color: var(--color-gray-400);
        letter-spacing: 0.5px;
        margin-bottom: 0.5rem;
    }

    .nav-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem 1.5rem;
        color: var(--color-gray-600);
        text-decoration: none;
        transition: all 0.2s;
        font-weight: 500;
        cursor: pointer;
        position: relative;
    }

    .nav-item:hover {
        background: var(--color-gray-50);
        color: var(--primary-purple);
    }

    .nav-item.active {
        background: linear-gradient(90deg, rgba(153, 38, 243, 0.1) 0%, transparent 100%);
        color: var(--primary-purple);
        border-right: 3px solid var(--primary-purple);
    }

    .nav-item i {
        font-size: 20px;
        width: 20px;
    }

    .nav-item-badge {
        margin-left: auto;
        padding: 0.125rem 0.5rem;
        background: var(--gradient-primary);
        color: white;
        border-radius: 12px;
        font-size: 10px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.3px;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {

        0%,
        100% {
            opacity: 1;
        }

        50% {
            opacity: 0.7;
        }
    }

    /* Sidebar Footer */
    .sidebar-footer {
        padding: 1rem;
        border-top: 1px solid var(--color-gray-200);
        margin-top: auto;
    }

    .sidebar-footer-link {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem 0.5rem;
        color: var(--color-gray-600);
        text-decoration: none;
        transition: all 0.2s;
        font-weight: 500;
        border-radius: var(--radius-md);
    }

    .sidebar-footer-link:hover {
        background: var(--color-gray-50);
        color: var(--primary-purple);
    }

    .sidebar-footer-link i {
        font-size: 20px;
    }

    /* Sidebar Toggle */
    .sidebar-toggle {
        position: absolute;
        top: 50%;
        right: -12px;
        transform: translateY(-50%);
        width: 24px;
        height: 24px;
        border-radius: 50%;
        border: 1px solid var(--color-gray-200);
        background: white;
        color: var(--color-gray-600);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        transition: all 0.2s;
        z-index: 1;
    }

    .sidebar-toggle:hover {
        background: var(--primary-purple);
        color: white;
        border-color: var(--primary-purple);
    }

    .sidebar.collapsed .sidebar-toggle i {
        transform: rotate(180deg);
    }

    /* Responsive */
    @media (max-width: 768px) {
        .sidebar {
            transform: translateX(-280px);
        }

        .sidebar.mobile-open {
            transform: translateX(0);
        }

        .sidebar-toggle {
            display: none;
        }
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Load user data
        loadSidebarUser();

        // Load navigation based on user role
        loadNavigation();

        // Sidebar toggle
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebarToggle');
        const mobileMenuToggle = document.getElementById('mobileMenuToggle');

        if (sidebarToggle) {
            sidebarToggle.addEventListener('click', function () {
                sidebar.classList.toggle('collapsed');
                document.body.classList.toggle('sidebar-collapsed');
                localStorage.setItem('sidebar-collapsed', sidebar.classList.contains('collapsed'));
            });

            // Restore sidebar state
            const isCollapsed = localStorage.getItem('sidebar-collapsed') === 'true';
            if (isCollapsed) {
                sidebar.classList.add('collapsed');
                document.body.classList.add('sidebar-collapsed');
            }
        }

        // Mobile menu toggle (if exists)
        if (mobileMenuToggle) {
            mobileMenuToggle.addEventListener('click', function () {
                sidebar.classList.toggle('mobile-open');
            });
        }

        // Logout handler
        const logoutBtn = document.getElementById('sidebarLogout');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', function (e) {
                e.preventDefault();
                handleLogout();
            });
        }
    });

    async function loadSidebarUser() {
        try {
           const token = localStorage.getItem('access_token');
        if (!token) return;
        
        const response = await fetch(`${APP_CONFIG.apiBaseUrl}/auth/me`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

            if (response.ok) {
                const data = await response.json();
                document.getElementById('sidebarUserName').textContent = data.full_name || data.email;
                document.getElementById('sidebarUserRole').textContent = data.role;

                if (data.avatar_url) {
                    document.getElementById('sidebarUserAvatar').src = data.avatar_url;
                }
            }
        } catch (error) {
            console.error('Error loading user:', error);
        }
    }

    function loadNavigation() {
        fetch('/api/v1/auth/me', { credentials: 'include' })
            .then(response => response.json())
            .then(data => {
                const navContainer = document.getElementById('sidebarNav');
                const role = data.role;

                navContainer.innerHTML = getNavigationByRole(role);

                // Set active nav item
                setActiveNavItem();

                // Load pending verifications count for admin
                if (role === 'admin') {
                    loadPendingVerificationsCount();
                }
            })
            .catch(error => console.error('Error loading navigation:', error));
    }

    function getNavigationByRole(role) {
        const commonModules = `
            <div class="nav-section">
                <div class="nav-section-title">Modules</div>
                <a href="/modules/project-planner" class="nav-item" data-path="/modules/project-planner">
                    <i class="ti ti-wand"></i>
                    <span>AI Project Planner</span>
                </a>
            </div>
        `;

        if (role === 'admin') {
            return `
            <div class="nav-section">
                <div class="nav-section-title">Dashboard</div>
                <a href="/dashboard/admin" class="nav-item" data-path="/dashboard/admin">
                    <i class="ti ti-dashboard"></i>
                    <span>Overview</span>
                </a>
                <a href="/admin/onboarding-verifications" class="nav-item" data-path="/admin/onboarding-verifications">
                <i class="ti ti-user-check"></i>
                    <span>Verify New Users</span>
                    <span class="nav-item-badge" id="pendingBadge" style="display: none;">0</span>
                 </a>
                <a href="/clients" class="nav-item" data-path="/clients">
                    <i class="ti ti-briefcase"></i>
                    <span>Clients</span>
                </a>
                <a href="/admin/packages" class="nav-item" data-path="/admin/packages">
                    <i class="ti ti-package"></i>
                    <span>Packages</span>
                </a>
            </div>
            <div class="nav-section">
                <div class="nav-section-title">Management</div>
                <a href="/admin/users" class="nav-item" data-path="/admin/users">
                    <i class="ti ti-users"></i>
                    <span>User Management</span>
                </a>
                <a href="/admin/tasks" class="nav-item" data-path="/admin/tasks">
                    <i class="ti ti-checklist"></i>
                    <span>Task Assignment</span>
                </a>
                <a href="/admin/finance" class="nav-item" data-path="/admin/finance">
                    <i class="ti ti-coin"></i>
                    <span>Finance & P&L</span>
                </a>
                <a href="/admin/access-control" class="nav-item" data-path="/admin/access-control">
                    <i class="ti ti-shield-lock"></i>
                    <span>Access Control</span>
                </a>
            </div>
            ${commonModules}
            <div class="nav-section">
                <div class="nav-section-title">Settings</div>
                <a href="/settings" class="nav-item" data-path="/settings">
                    <i class="ti ti-settings"></i>
                    <span>Settings</span>
                </a>
            </div>
        `;
        } else if (role === 'employee') {
            return `
            <div class="nav-section">
                <div class="nav-section-title">Dashboard</div>
                <a href="/dashboard/employee" class="nav-item" data-path="/dashboard/employee">
                    <i class="ti ti-dashboard"></i>
                    <span>Overview</span>
                </a>
            </div>
            <div class="nav-section">
                <div class="nav-section-title">Client Management</div>
                <a href="/clients" class="nav-item" data-path="/clients">
                    <i class="ti ti-briefcase"></i>
                    <span>My Clients</span>
                </a>
                <a href="/employee/tasks" class="nav-item" data-path="/employee/tasks">
                    <i class="ti ti-checklist"></i>
                    <span>My Tasks</span>
                </a>
            </div>
            ${commonModules}
            <div class="nav-section">
                <div class="nav-section-title">Settings</div>
                <a href="/settings" class="nav-item" data-path="/settings">
                    <i class="ti ti-settings"></i>
                    <span>Settings</span>
                </a>
            </div>
        `;
        } else if (role === 'client') {
            return `
            <div class="nav-section">
                <div class="nav-section-title">Dashboard</div>
                <a href="/dashboard/client" class="nav-item" data-path="/dashboard/client">
                    <i class="ti ti-dashboard"></i>
                    <span>Overview</span>
                </a>
            </div>
            <div class="nav-section">
                <div class="nav-section-title">My Account</div>
                <a href="/client/package" class="nav-item" data-path="/client/package">
                    <i class="ti ti-package"></i>
                    <span>My Package</span>
                </a>
                <a href="/client/campaigns" class="nav-item" data-path="/client/campaigns">
                    <i class="ti ti-chart-bar"></i>
                    <span>Campaign Reports</span>
                </a>
                <a href="/client/support" class="nav-item" data-path="/client/support">
                    <i class="ti ti-help-circle"></i>
                    <span>Support Tickets</span>
                </a>
            </div>
            <div class="nav-section">
                <div class="nav-section-title">Settings</div>
                <a href="/settings" class="nav-item" data-path="/settings">
                    <i class="ti ti-settings"></i>
                    <span>Settings</span>
                </a>
            </div>
        `;
        }

        return '';
    }

    function setActiveNavItem() {
        const currentPath = window.location.pathname;
        const navItems = document.querySelectorAll('.nav-item');

        navItems.forEach(item => {
            const itemPath = item.getAttribute('data-path');
            if (itemPath && currentPath.startsWith(itemPath)) {
                item.classList.add('active');
            }
        });
    }

    async function loadPendingVerificationsCount() {
        try {
            const response = await fetch('/api/v1/admin/verifications/pending-count', {
                credentials: 'include'
            });

            if (response.ok) {
                const data = await response.json();
                const badge = document.getElementById('pendingBadge');
                if (badge && data.count > 0) {
                    badge.textContent = data.count;
                    badge.style.display = 'block';
                }
            }
        } catch (error) {
            console.error('Error loading pending count:', error);
        }
    }

    async function handleLogout() {
        try {
            const response = await fetch('/api/v1/auth/logout', {
                method: 'POST',
                credentials: 'include'
            });

            if (response.ok) {
                window.location.href = '/auth/login';
            }
        } catch (error) {
            console.error('Logout error:', error);
            window.location.href = '/auth/login';
        }
    }
</script>