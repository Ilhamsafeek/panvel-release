{% extends "base.html" %}

{% block title %}AI Project Planner{% endblock %}

{% set show_sidebar = True %}


{% block extra_css %}
<!-- Quill Rich Text Editor -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<style>
    /* =====================================================
       VARIABLES & BASE
       ===================================================== */
    :root {
        --primary-purple: #9926F3;
        --primary-cyan: #1DD8FC;
        --gradient-primary: linear-gradient(135deg, #9926F3, #1DD8FC);
        --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    }

    .planner-container {
        padding: 2rem;
        max-width: 100%;
        background: var(--color-gray-50);
        min-height: 100vh;
    }



    .header-subtitle {
        font-size: 14px;
        color: var(--color-gray-600);
        margin-top: 0.5rem;
    }

    .header-actions {
        display: flex;
        gap: 1rem;
    }

    /* =====================================================
       BUTTONS
       ===================================================== */
    .btn {
        padding: 0.75rem 1.5rem;
        border-radius: 10px;
        border: none;
        font-weight: 600;
        font-size: 14px;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.3s ease;
        text-decoration: none;
    }

    .btn-primary {
        background: var(--gradient-primary);
        color: white;
        box-shadow: var(--shadow-md);
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
    }

    .btn-secondary {
        background: white;
        color: var(--color-gray-700);
        border: 2px solid var(--color-gray-300);
    }

    .btn-secondary:hover {
        background: var(--color-gray-50);
        border-color: var(--color-gray-400);
    }

    .btn-success {
        background: linear-gradient(135deg, #10B981, #059669);
        color: white;
        box-shadow: var(--shadow-md);
    }

    .btn-success:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
    }

    .btn-outline {
        background: white;
        color: var(--primary-purple);
        border: 2px solid var(--primary-purple);
    }

    .btn-outline:hover {
        background: rgba(153, 38, 243, 0.05);
    }

    .btn-sm {
        padding: 0.5rem 1rem;
        font-size: 13px;
    }

    /* =====================================================
       TAB NAVIGATION
       ===================================================== */
    .tab-navigation {
        background: white;
        border-radius: 16px;
        padding: 0.5rem;
        margin-bottom: 2rem;
        display: flex;
        gap: 0.5rem;
        box-shadow: var(--shadow-sm);
    }

    .tab-btn {
        padding: 0.875rem 1.5rem;
        border: none;
        background: transparent;
        border-radius: 10px;
        font-weight: 600;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--color-gray-600);
    }

    .tab-btn.active {
        background: var(--gradient-primary);
        color: white;
    }

    .tab-btn:not(.active):hover {
        background: var(--color-gray-100);
    }

    /* =====================================================
       TAB CONTENT
       ===================================================== */
    .tab-content {
        display: none;
        animation: fadeIn 0.3s ease;
    }

    .tab-content.active {
        display: block;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* =====================================================
       STEPPER (3-STEP WIZARD)
       ===================================================== */
    .stepper-container {
        /* background: white;
        border-radius: 16px; */
        padding-bottom: 1rem;
        /* box-shadow: var(--shadow-md); */
    }

    .stepper-wrapper {
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: relative;
        max-width: 800px;
        margin: 0 auto;
    }

    .stepper-line-bg {
        position: absolute;
        top: 32px;
        left: 15%;
        right: 15%;
        height: 4px;
        background: var(--color-gray-200);
        z-index: 1;
    }

    .stepper-line-progress {
        position: absolute;
        top: 32px;
        left: 15%;
        height: 4px;
        background: var(--gradient-primary);
        z-index: 2;
        transition: width 0.5s ease;
        width: 0%;
    }

    .stepper-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.75rem;
        position: relative;
        z-index: 3;
        flex: 1;
    }

    .step-counter {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: white;
        color: var(--color-gray-400);
        font-size: 1rem;
        font-weight: 600;
        transition: all 0.3s ease;
        border: 4px solid var(--color-gray-200);
    }

    .stepper-item.active .step-counter {
        background: var(--gradient-primary);
        color: white;
        border-color: var(--primary-purple);
        box-shadow: 0 0 0 8px rgba(153, 38, 243, 0.1);
        transform: scale(1.1);
    }

    .stepper-item.completed .step-counter {
        background: #10B981;
        color: white;
        border-color: #10B981;
    }

    .step-info {
        text-align: center;
    }

    .step-name {
        font-weight: 700;
        font-size: 1rem;
        color: var(--color-gray-500);
        transition: all 0.3s ease;
    }

    .stepper-item.active .step-name {
        color: var(--primary-purple);
    }

    .stepper-item.completed .step-name {
        color: #10B981;
    }

    .step-desc {
        font-size: 0.75rem;
        color: var(--color-gray-400);
        margin-top: 0.25rem;
    }

    /* =====================================================
       STEP CONTENT CARDS
       ===================================================== */
    .step-content {
        display: none;
    }

    .step-content.active {
        display: block;
        animation: slideInUp 0.4s ease;
    }

    @keyframes slideInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .step-card {
        background: white;
        border-radius: 16px;
        box-shadow: var(--shadow-lg);
        overflow: hidden;
        margin-bottom: 2rem;
    }

    .step-card-header {
        background: var(--gradient-primary);
        color: white;
        padding: 1rem;
        text-align: center;
    }

    .step-card-header h2 {
        font-weight: 700;
        margin: 0 0 0.5rem 0;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.75rem;
    }

    .step-card-header h2 i {
        font-size: 2rem;
    }

    .step-card-header p {
        margin: 0;
        font-size: 1rem;
        opacity: 0.95;
    }

    .step-card-body {
        padding: 2.5rem;
    }

    /* =====================================================
       FORM ELEMENTS
       ===================================================== */
    .form-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .form-group {
        display: flex;
        flex-direction: column;
    }

    .form-group.full-width {
        grid-column: 1 / -1;
    }

    .form-label {
        font-weight: 600;
        font-size: 14px;
        color: var(--color-gray-700);
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .form-label i {
        color: var(--primary-purple);
        font-size: 18px;
    }

    .form-label .required {
        color: #EF4444;
    }

    .form-input,
    .form-textarea,
    .form-select {
        padding: 0.875rem 1rem;
        border: 2px solid var(--color-gray-300);
        border-radius: 10px;
        font-size: 14px;
        font-family: 'Gilroy', sans-serif;
        transition: all 0.3s ease;
        background: white;
    }

    .form-input:focus,
    .form-textarea:focus,
    .form-select:focus {
        outline: none;
        border-color: var(--primary-purple);
        box-shadow: 0 0 0 4px rgba(153, 38, 243, 0.1);
    }

    .form-textarea {
        min-height: 100px;
        resize: vertical;
    }

    .form-select {
        cursor: pointer;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%239926F3' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 0.75rem center;
        background-size: 1.25rem;
        padding-right: 2.5rem;
    }

    /* =====================================================
       CHECKBOXES
       ===================================================== */
    .checkbox-group {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
        margin-top: 0.5rem;
    }

    .checkbox-label {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem;
        background: var(--color-gray-50);
        border: 2px solid var(--color-gray-200);
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .checkbox-label:hover {
        border-color: var(--primary-purple);
        background: rgba(153, 38, 243, 0.05);
    }

    .checkbox-label input[type="checkbox"] {
        width: 18px;
        height: 18px;
        accent-color: var(--primary-purple);
        cursor: pointer;
    }

    .checkbox-label span {
        font-weight: 500;
        font-size: 14px;
        color: var(--color-gray-700);
    }

    /* =====================================================
       STEP NAVIGATION
       ===================================================== */
    .step-navigation {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 2rem;
        padding-top: 2rem;
        border-top: 2px solid var(--color-gray-200);
    }

    /* =====================================================
       RICH TEXT EDITOR (QUILL)
       ===================================================== */
    #editorContainer {
        margin-top: 1.5rem;
    }

    #toolbar {
        background: var(--color-gray-50);
        border: 2px solid var(--color-gray-200);
        border-bottom: none;
        border-radius: 12px 12px 0 0;
        padding: 0.75rem;
    }

    #editor {
        min-height: 600px;
        background: white;
        border: 2px solid var(--color-gray-200);
        border-top: none;
        border-radius: 0 0 12px 12px;
        font-family: 'Gilroy', sans-serif;
        font-size: 14px;
    }

    .ql-container {
        font-family: 'Gilroy', sans-serif !important;
        font-size: 14px !important;
    }

    .ql-editor {
        padding: 2rem !important;
        min-height: 600px !important;
    }

    .ql-toolbar {
        border: none !important;
        background: transparent !important;
    }

    .ql-formats {
        margin-right: 1rem !important;
    }

    .ql-stroke {
        stroke: var(--primary-purple) !important;
    }

    .ql-fill {
        fill: var(--primary-purple) !important;
    }

    .ql-picker-label {
        color: var(--primary-purple) !important;
    }

    /* =====================================================
       AI INSIGHTS PANEL
       ===================================================== */
    .ai-insights-panel {
        margin-top: 1.5rem;
        background: linear-gradient(135deg, rgba(153, 38, 243, 0.05), rgba(29, 216, 252, 0.05));
        border: 2px solid rgba(153, 38, 243, 0.2);
        border-radius: 12px;
        padding: 1.5rem;
    }

    .ai-insights-panel h3 {
        font-size: 1.125rem;
        font-weight: 700;
        color: var(--primary-purple);
        margin: 0 0 1rem 0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .ai-insight-item {
        background: white;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 0.75rem;
        box-shadow: var(--shadow-sm);
    }

    .ai-insight-item:last-child {
        margin-bottom: 0;
    }

    .insight-title {
        font-weight: 600;
        font-size: 14px;
        color: var(--color-gray-900);
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .insight-content {
        font-size: 13px;
        color: var(--color-gray-600);
        line-height: 1.6;
    }

    /* =====================================================
       LOADING STATE
       ===================================================== */
    .loading-state {
        text-align: center;
        padding: 4rem 2rem;
    }

    .loader-spinner {
        width: 60px;
        height: 60px;
        border: 5px solid var(--color-gray-200);
        border-top-color: var(--primary-purple);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 1.5rem;
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }

    .loading-state p {
        font-size: 1.125rem;
        font-weight: 600;
        color: var(--color-gray-900);
        margin-bottom: 0.5rem;
    }

    .loading-state small {
        font-size: 14px;
        color: var(--color-gray-600);
    }

    /* =====================================================
       EXPORT OPTIONS (STEP 3)
       ===================================================== */
    .proposal-summary {
        background: var(--color-gray-50);
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }

    .proposal-summary h3 {
        font-size: 1.125rem;
        font-weight: 700;
        color: var(--color-gray-900);
        margin: 0 0 1rem 0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .summary-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
    }

    .summary-item {
        display: flex;
        justify-content: space-between;
        padding: 0.75rem;
        background: white;
        border-radius: 8px;
        border: 1px solid var(--color-gray-200);
    }

    .summary-label {
        font-weight: 600;
        font-size: 13px;
        color: var(--color-gray-600);
    }

    .summary-value {
        font-weight: 700;
        font-size: 14px;
        color: var(--color-gray-900);
    }

    .export-options {
        margin-top: 2rem;
    }

    .export-options h3 {
        font-size: 1.125rem;
        font-weight: 700;
        color: var(--color-gray-900);
        margin: 0 0 1.5rem 0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .export-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
    }

    .export-card {
        background: white;
        border: 2px solid var(--color-gray-200);
        border-radius: 12px;
        padding: 1.5rem;
        text-align: center;
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .export-card:hover {
        border-color: var(--primary-purple);
        box-shadow: var(--shadow-lg);
        transform: translateY(-4px);
    }

    .export-icon {
        width: 64px;
        height: 64px;
        background: var(--gradient-primary);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1rem;
    }

    .export-icon i {
        font-size: 2rem;
        color: white;
    }

    .export-card h4 {
        font-size: 1.125rem;
        font-weight: 700;
        color: var(--color-gray-900);
        margin: 0 0 0.5rem 0;
    }

    .export-card p {
        font-size: 13px;
        color: var(--color-gray-600);
        margin: 0 0 1rem 0;
    }

    .share-link-result {
        margin-top: 2rem;
        padding: 1.5rem;
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.05), rgba(5, 150, 105, 0.05));
        border: 2px solid rgba(16, 185, 129, 0.3);
        border-radius: 12px;
    }

    .share-link-container h4 {
        font-size: 1.125rem;
        font-weight: 700;
        color: #10B981;
        margin: 0 0 1rem 0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .link-display {
        display: flex;
        gap: 0.75rem;
        margin-bottom: 0.75rem;
    }

    .link-display input {
        flex: 1;
        padding: 0.75rem 1rem;
        border: 2px solid var(--color-gray-300);
        border-radius: 8px;
        font-size: 14px;
        background: white;
    }

    .link-info {
        font-size: 13px;
        color: var(--color-gray-600);
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    /* =====================================================
       PROPOSALS LIST (ALL TAB)
       ===================================================== */
    .proposals-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 1.5rem;
    }

    .proposal-card {
        background: white;
        border-radius: 16px;
        padding: 1.5rem;
        box-shadow: var(--shadow-md);
        transition: all 0.3s ease;
        border: 1px solid var(--color-gray-200);
    }

    .proposal-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-xl);
    }

    .proposal-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: 1rem;
    }

    .proposal-client {
        flex: 1;
    }

    .proposal-client h3 {
        font-size: 18px;
        font-weight: 700;
        color: var(--color-gray-900);
        margin-bottom: 0.25rem;
    }

    .proposal-client p {
        font-size: 14px;
        color: var(--color-gray-600);
    }

    .status-badge {
        padding: 0.375rem 0.75rem;
        border-radius: 8px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
    }

    .status-draft {
        background: rgba(251, 191, 36, 0.1);
        color: #F59E0B;
    }

    .status-sent {
        background: rgba(59, 130, 246, 0.1);
        color: #3B82F6;
    }

    .status-accepted {
        background: rgba(16, 185, 129, 0.1);
        color: #10B981;
    }

    .status-rejected {
        background: rgba(239, 68, 68, 0.1);
        color: #EF4444;
    }

    .proposal-details {
        margin: 1rem 0;
        padding: 1rem;
        background: var(--color-gray-50);
        border-radius: 12px;
    }

    .detail-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 0;
        font-size: 14px;
    }

    .detail-item:not(:last-child) {
        border-bottom: 1px solid var(--color-gray-200);
    }

    .detail-label {
        color: var(--color-gray-600);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .detail-value {
        font-weight: 600;
        color: var(--color-gray-900);
    }

    .proposal-actions {
        display: flex;
        gap: 0.5rem;
        margin-top: 1rem;
    }

    .proposal-actions .btn {
        flex: 1;
    }

    /* =====================================================
       EMPTY STATE
       ===================================================== */
    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        background: white;
        border-radius: 16px;
        box-shadow: var(--shadow-sm);
    }

    .empty-state i {
        font-size: 80px;
        color: var(--color-gray-300);
        margin-bottom: 1rem;
    }

    .empty-state h3 {
        font-size: 20px;
        font-weight: 700;
        color: var(--color-gray-900);
        margin-bottom: 0.5rem;
    }

    .empty-state p {
        color: var(--color-gray-600);
        margin-bottom: 1.5rem;
    }

    /* =====================================================
       MODAL
       ===================================================== */
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 9999;
        align-items: center;
        justify-content: center;
    }

    .modal.active {
        display: flex;
    }

    .modal-content {
        background: white;
        border-radius: 16px;
        max-width: 600px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: var(--shadow-xl);
    }

    .modal-header {
        background: var(--gradient-primary);
        color: white;
        padding: 1.5rem 2rem;
        border-radius: 16px 16px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-header h3 {
        margin: 0;
        font-size: 1.25rem;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .modal-close {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
    }

    .modal-close:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: rotate(90deg);
    }

    .modal-body {
        padding: 2rem;
    }

    .modal-footer {
        padding: 1.5rem 2rem;
        border-top: 1px solid var(--color-gray-200);
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
    }

    /* =====================================================
       LOADING OVERLAY
       ===================================================== */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 9999;
    }

    .loading-overlay.active {
        display: flex;
    }

    .loading-content {
        background: white;
        padding: 2rem 3rem;
        border-radius: 16px;
        text-align: center;
        max-width: 400px;
    }

    .spinner {
        width: 50px;
        height: 50px;
        border: 4px solid var(--color-gray-200);
        border-top-color: var(--primary-purple);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
    }

    .loading-content h3 {
        font-size: 18px;
        font-weight: 700;
        color: var(--color-gray-900);
        margin-bottom: 0.5rem;
    }

    .loading-content p {
        color: var(--color-gray-600);
        font-size: 14px;
    }

    /* =====================================================
       RESPONSIVE
       ===================================================== */
    @media (max-width: 768px) {
        .planner-container {
            padding: 1rem;
        }

        .planner-header {
            flex-direction: column;
            gap: 1rem;
            align-items: flex-start;
        }

        .header-actions {
            width: 100%;
            flex-direction: column;
        }

        .header-actions .btn {
            width: 100%;
            justify-content: center;
        }

        .tab-navigation {
            flex-direction: column;
        }

        .stepper-wrapper {
            flex-direction: column;
            gap: 1.5rem;
        }

        .stepper-line-bg,
        .stepper-line-progress {
            display: none;
        }

        .step-counter {
            width: 56px;
            height: 56px;
            font-size: 1.5rem;
        }

        .form-grid {
            grid-template-columns: 1fr;
        }

        .summary-grid {
            grid-template-columns: 1fr;
        }

        .export-grid {
            grid-template-columns: 1fr;
        }

        .proposals-grid {
            grid-template-columns: 1fr;
        }

        .step-card-body {
            padding: 1.5rem;
        }

        #editor {
            min-height: 400px;
        }

        .ql-editor {
            padding: 1rem !important;
            min-height: 400px !important;
        }
    }


    /* Retry Dialog Styles */
    .retry-dialog-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        animation: fadeIn 0.3s ease;
    }

    .retry-dialog {
        background: white;
        border-radius: 12px;
        padding: 32px;
        max-width: 400px;
        width: 90%;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        animation: slideUp 0.3s ease;
    }

    .retry-dialog-icon {
        text-align: center;
        margin-bottom: 20px;
    }

    .retry-dialog h3 {
        font-family: 'Gilroy-SemiBold', sans-serif;
        font-size: 24px;
        color: #1a1a1a;
        margin-bottom: 12px;
        text-align: center;
    }

    .retry-dialog p {
        color: #666;
        font-size: 16px;
        line-height: 1.6;
        margin-bottom: 24px;
        text-align: center;
    }

    .retry-dialog-actions {
        display: flex;
        gap: 12px;
        justify-content: center;
    }

    .retry-dialog-actions .btn {
        min-width: 120px;
    }

    @keyframes slideUp {
        from {
            transform: translateY(20px);
            opacity: 0;
        }

        to {
            transform: translateY(0);
            opacity: 1;
        }
    }


    /* Success Dialog Styles */
    .success-dialog-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        animation: fadeIn 0.3s ease;
    }

    .success-dialog {
        background: white;
        border-radius: 16px;
        padding: 40px;
        max-width: 480px;
        width: 90%;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        text-align: center;
        animation: slideUp 0.3s ease;
    }

    .success-dialog-icon {
        margin-bottom: 24px;
    }

    .success-dialog h3 {
        font-family: 'Gilroy-Bold', sans-serif;
        font-size: 28px;
        color: #1a1a1a;
        margin-bottom: 16px;
    }

    .success-dialog p {
        color: #666;
        font-size: 16px;
        line-height: 1.6;
        margin-bottom: 32px;
    }

    .success-dialog-details {
        background: #F0FDF4;
        border-radius: 12px;
        padding: 24px;
        margin-bottom: 32px;
    }

    .detail-item {
        display: flex;
        align-items: center;
        gap: 12px;
        color: #059669;
        font-family: 'Gilroy-Medium', sans-serif;
        font-size: 15px;
        padding: 8px 0;
    }

    .detail-item i {
        font-size: 20px;
    }

    .success-dialog .btn {
        min-width: 160px;
        padding: 12px 32px;
    }
</style>
{% endblock %}

{% block content %}
<div class="planner-container">
    <!-- Header -->
    <div class="header-hero">
        <div>
            <h1>
                <i class="ti ti-bulb"></i>
                AI Project Planner
            </h1>
            <p class="header-subtitle">Generate AI-powered marketing proposals in 3 simple steps</p>
        </div>
        <div class="header-actions">
            <button class="btn btn-primary" onclick="showCreateTab()">
                <i class="ti ti-plus"></i>
                Create New Proposal
            </button>
        </div>
    </div>

    <!-- Tab Navigation -->
    <div class="tab-navigation">
        <button class="tab-btn" data-tab="create" onclick="switchTab('create')">
            <i class="ti ti-file-plus"></i>
            Create Proposal
        </button>
        <button class="tab-btn active" data-tab="proposals" onclick="switchTab('proposals')">
            <i class="ti ti-list"></i>
            All Proposals
        </button>
    </div>

    <!-- Tab: Create Proposal (3-Step Wizard) -->
    <div class="tab-content" id="tab-create">
        <!-- Stepper -->
        <div class="stepper-container">
            <div class="stepper-wrapper">
                <div class="stepper-line-bg"></div>
                <div class="stepper-line-progress" id="stepperProgress"></div>

                <div class="stepper-item active" data-step="1">
                    <div class="step-counter">
                        <i class="ti ti-user"></i>
                    </div>
                    <div class="step-info">
                        <div class="step-name">Client Details</div>
                        <!-- <div class="step-desc">Basic information</div> -->
                    </div>
                </div>

                <div class="stepper-item" data-step="2">
                    <div class="step-counter">
                        <i class="ti ti-brain"></i>
                    </div>
                    <div class="step-info">
                        <div class="step-name">AI Strategy</div>
                        <!-- <div class="step-desc">Generated & editable</div> -->
                    </div>
                </div>

                <div class="stepper-item" data-step="3">
                    <div class="step-counter">
                        <i class="ti ti-send"></i>
                    </div>
                    <div class="step-info">
                        <div class="step-name">Export & Share</div>
                        <!-- <div class="step-desc">Final delivery</div> -->
                    </div>
                </div>
            </div>
        </div>

        <!-- STEP 1: Client Details -->
        <div class="step-content active" id="step1">
            <div class="step-card">
                <div class="step-card-header">
                    <h2>
                        <i class="ti ti-user-circle"></i>
                        Client Information
                    </h2>
                    <p>Enter the client's business details to generate a personalized proposal</p>
                </div>

                <div class="step-card-body">
                    <form id="clientDetailsForm">
                        <div class="form-grid">
                            <!-- Lead Name -->
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="ti ti-user"></i>
                                    Contact Person Name <span class="required">*</span>
                                </label>
                                <input type="text" id="leadName" name="lead_name" required placeholder="Linson Dominic"
                                    class="form-input">
                            </div>

                            <!-- Lead Email -->
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="ti ti-mail"></i>
                                    Email Address <span class="required">*</span>
                                </label>
                                <input type="email" id="leadEmail" name="lead_email" required
                                    placeholder="linson@company.com" class="form-input">
                            </div>

                            <!-- Company Name -->
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="ti ti-building"></i>
                                    Company Name <span class="required">*</span>
                                </label>
                                <input type="text" id="companyName" name="company_name" required
                                    placeholder="Acme Corporation" class="form-input">
                            </div>

                            <!-- Business Type -->
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="ti ti-briefcase"></i>
                                    Business Type <span class="required">*</span>
                                </label>
                                <select id="businessType" name="business_type" required class="form-select">
                                    <option value="">Select business type</option>
                                    <option value="E-commerce">E-Commerce</option>
                                    <option value="SaaS">SaaS / Technology</option>
                                    <option value="Healthcare">Healthcare</option>
                                    <option value="Education">Education</option>
                                    <option value="Real Estate">Real Estate</option>
                                    <option value="Hospitality">Hospitality</option>
                                    <option value="Finance">Finance</option>
                                    <option value="Retail">Retail</option>
                                    <option value="Manufacturing">Manufacturing</option>
                                    <option value="Professional Services">Professional Services</option>
                                    <option value="Restaurant">Restaurant</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label class="form-label">
                                    <i class="ti ti-world"></i>
                                    Website URL
                                </label>
                                <input type="url" id="websiteUrl" name="website_url" placeholder="https://example.com"
                                    class="form-input" pattern="https?://.*"
                                    title="Please enter a valid URL starting with http:// or https://">
                                <small class="form-hint"
                                    style="color: #666; font-size: 12px; margin-top: 4px; display: block;">
                                    Format: https://example.com
                                </small>
                            </div>


                            <!-- Budget -->
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="ti ti-currency-dollar"></i>
                                    Marketing Budget (INR) <span class="required">*</span>
                                </label>
                                <input type="number" id="budget" name="budget" required placeholder="50000" min="0"
                                    class="form-input">
                            </div>

                            <!-- Target Audience -->
                            <div class="form-group full-width">
                                <label class="form-label">
                                    <i class="ti ti-users"></i>
                                    Target Audience <span class="required">*</span>
                                </label>
                                <textarea id="targetAudience" name="target_audience" required
                                    placeholder="Describe the target audience: demographics, interests, pain points..."
                                    rows="3" class="form-textarea"></textarea>
                            </div>

                            <!-- Current Challenges -->
                            <div class="form-group full-width">
                                <label class="form-label">
                                    <i class="ti ti-alert-circle"></i>
                                    Current Marketing Challenges <span class="required">*</span>
                                </label>
                                <textarea id="challenges" name="challenges" required
                                    placeholder="What are the main marketing challenges the client is facing?" rows="3"
                                    class="form-textarea"></textarea>
                            </div>

                            <!-- Existing Digital Presence -->
                            <div class="form-group full-width">
                                <label class="form-label">
                                    <i class="ti ti-world"></i>
                                    Existing Digital Presence
                                </label>
                                <div class="checkbox-group">


                                    <label class="checkbox-label">
                                        <input type="checkbox" name="existing_website" value="true">
                                        <span>Website</span>
                                    </label>

                                    <label class="checkbox-label">
                                        <input type="checkbox" name="existing_facebook" value="true">
                                        <span>Facebook</span>
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" name="existing_instagram" value="true">
                                        <span>Instagram</span>
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" name="existing_linkedin" value="true">
                                        <span>LinkedIn</span>
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" name="existing_google_ads" value="true">
                                        <span>Google Ads</span>
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" name="existing_seo" value="true">
                                        <span>SEO</span>
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" name="existing_youtube" value="true">
                                        <span>YouTube</span>
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" name="existing_email" value="true">
                                        <span>Email Marketing</span>
                                    </label>
                                </div>
                            </div>


                        </div>

                        <!-- Navigation -->
                        <div class="step-navigation">
                            <button type="button" class="btn btn-secondary" disabled>
                                <i class="ti ti-arrow-left"></i>
                                Previous
                            </button>
                            <button type="submit" class="btn btn-primary">
                                Generate AI Strategy
                                <i class="ti ti-sparkles"></i>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- STEP 2: AI Strategy (Rich Editor) -->
        <div class="step-content" id="step2">
            <div class="step-card">
                <div class="step-card-header">
                    <h2>
                        <i class="ti ti-brain"></i>
                        AI-Generated Strategy
                    </h2>
                    <p>Review and customize the AI-generated proposal using the rich text editor</p>
                </div>

                <div class="step-card-body">
                    <!-- Loading State -->
                    <div id="aiLoadingState" class="loading-state">
                        <div class="loader-spinner"></div>
                        <p>AI is generating your personalized strategy...</p>
                        <small>This may take a few moments</small>
                    </div>

                    <!-- Editor Container -->
                    <div id="editorContainer" style="display: none;">
                        <!-- Rich Text Editor Toolbar -->
                        <div id="toolbar">
                            <!-- Text Formatting -->
                            <span class="ql-formats">
                                <select class="ql-font"></select>
                                <select class="ql-size"></select>
                            </span>

                            <span class="ql-formats">
                                <button class="ql-bold"></button>
                                <button class="ql-italic"></button>
                                <button class="ql-underline"></button>
                                <button class="ql-strike"></button>
                            </span>

                            <!-- Color -->
                            <span class="ql-formats">
                                <select class="ql-color"></select>
                                <select class="ql-background"></select>
                            </span>

                            <!-- Text Alignment -->
                            <span class="ql-formats">
                                <button class="ql-align" value=""></button>
                                <button class="ql-align" value="center"></button>
                                <button class="ql-align" value="right"></button>
                                <button class="ql-align" value="justify"></button>
                            </span>

                            <!-- Lists -->
                            <span class="ql-formats">
                                <button class="ql-list" value="ordered"></button>
                                <button class="ql-list" value="bullet"></button>
                                <button class="ql-indent" value="-1"></button>
                                <button class="ql-indent" value="+1"></button>
                            </span>

                            <!-- Headings -->
                            <span class="ql-formats">
                                <button class="ql-header" value="1"></button>
                                <button class="ql-header" value="2"></button>
                                <button class="ql-blockquote"></button>
                            </span>

                            <!-- Insert -->
                            <span class="ql-formats">
                                <button class="ql-link"></button>
                                <button class="ql-image"></button>
                            </span>

                            <!-- Clear Formatting -->
                            <span class="ql-formats">
                                <button class="ql-clean"></button>
                            </span>
                        </div>

                        <!-- Editor Area -->
                        <div id="editor"></div>

                        <!-- AI Insights Panel -->
                        <div class="ai-insights-panel">
                            <h3>
                                <i class="ti ti-bulb"></i>
                                AI Insights
                            </h3>
                            <div id="aiInsightsContent">
                                <!-- Will be populated with AI suggestions -->
                            </div>
                        </div>

                    </div>

                    <!-- Navigation -->
                    <div class="step-navigation" id="step2Navigation" style="display: none;">
                        <button type="button" class="btn btn-secondary" onclick="goToStep(1)">
                            <i class="ti ti-arrow-left"></i>
                            Previous
                        </button>
                        <button type="button" class="btn btn-primary" onclick="goToStep(3)">
                            Continue to Export
                            <i class="ti ti-arrow-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- STEP 3: Export & Share -->
        <div class="step-content" id="step3">
            <div class="step-card">
                <div class="step-card-header">
                    <h2>
                        <i class="ti ti-send"></i>
                        Export & Share Proposal
                    </h2>
                    <p>Choose how to deliver the proposal to your client</p>
                </div>

                <div class="step-card-body">
                    <!-- Preview Summary -->
                    <div class="proposal-summary">
                        <h3>
                            <i class="ti ti-file-check"></i>
                            Proposal Summary
                        </h3>
                        <div id="proposalSummaryContent" class="summary-grid">
                            <!-- Will be populated with proposal details -->
                        </div>
                    </div>

                    <!-- Export Options -->
                    <div class="export-options">
                        <h3>
                            <i class="ti ti-download"></i>
                            Export Options
                        </h3>

                        <div class="export-grid">
                            <!-- PDF Export -->
                            <div class="export-card" onclick="exportProposal('pdf')">
                                <div class="export-icon">
                                    <i class="ti ti-file-type-pdf"></i>
                                </div>
                                <h4>Download PDF</h4>
                                <p>Professional PDF document</p>
                                <button type="button" class="btn btn-outline-primary">
                                    <i class="ti ti-download"></i>
                                    Export PDF
                                </button>
                            </div>

                            <!-- Share Link -->
                            <div class="export-card" onclick="generateShareLink()">
                                <div class="export-icon">
                                    <i class="ti ti-link"></i>
                                </div>
                                <h4>Share Link</h4>
                                <p>Interactive web link</p>
                                <button type="button" class="btn btn-outline-primary">
                                    <i class="ti ti-share"></i>
                                    Generate Link
                                </button>
                            </div>

                            <!-- Email -->
                            <div class="export-card" onclick="openEmailModal()">
                                <div class="export-icon">
                                    <i class="ti ti-mail"></i>
                                </div>
                                <h4>Send Email</h4>
                                <p>Email directly to client</p>
                                <button type="button" class="btn btn-outline-primary">
                                    <i class="ti ti-send"></i>
                                    Send Email
                                </button>
                            </div>

                            <!-- Client Dashboard -->
                            <div class="export-card" onclick="sendToDashboard()">
                                <div class="export-icon">
                                    <i class="ti ti-layout-dashboard"></i>
                                </div>
                                <h4>Client Dashboard</h4>
                                <p>Add to client portal</p>
                                <button type="button" class="btn btn-outline-primary">
                                    <i class="ti ti-upload"></i>
                                    Send to Dashboard
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Share Link Result -->
                    <div id="shareLinkResult" class="share-link-result" style="display: none;">
                        <div class="share-link-container">
                            <h4>
                                <i class="ti ti-check-circle"></i>
                                Share Link Generated
                            </h4>
                            <div class="link-display">
                                <input type="text" id="generatedLink" readonly class="form-input">
                                <button type="button" class="btn btn-primary" onclick="copyShareLink()">
                                    <i class="ti ti-copy"></i>
                                    Copy
                                </button>
                            </div>
                            <p class="link-info">
                                <i class="ti ti-info-circle"></i>
                                This link will expire in 30 days
                            </p>
                        </div>
                    </div>

                    <!-- Navigation -->
                    <div class="step-navigation">
                        <button type="button" class="btn btn-secondary" onclick="goToStep(2)">
                            <i class="ti ti-arrow-left"></i>
                            Back to Editor
                        </button>
                        <button type="button" class="btn btn-success" onclick="finishProposal()">
                            <i class="ti ti-check"></i>
                            Complete Proposal
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab: All Proposals -->
    <div class="tab-content active" id="tab-proposals">
        <div id="proposalsContainer">
            <!-- Proposals will be loaded here -->
        </div>
    </div>
</div>

<!-- Email Modal -->
<div class="modal" id="emailModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>
                <i class="ti ti-mail"></i>
                Send Proposal via Email
            </h3>
            <button class="modal-close" onclick="closeModal('emailModal')">
                <i class="ti ti-x"></i>
            </button>
        </div>
        <div class="modal-body">
            <form id="emailForm">
                <div class="form-group">
                    <label class="form-label">
                        <i class="ti ti-mail"></i>
                        Recipient Email
                    </label>
                    <input type="email" id="recipientEmail" class="form-input" required>
                </div>

                <div class="form-group">
                    <label class="form-label">
                        <i class="ti ti-edit"></i>
                        Subject
                    </label>
                    <input type="text" id="emailSubject" class="form-input" value="Marketing Proposal for Your Review"
                        required>
                </div>

                <div class="form-group">
                    <label class="form-label">
                        <i class="ti ti-message"></i>
                        Message
                    </label>
                    <textarea id="emailMessage" class="form-textarea" rows="5" required>Dear Client,

Please find attached our comprehensive marketing proposal tailored to your business needs.

We look forward to discussing this proposal with you.

Best regards,
PanvelIQ Team</textarea>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal('emailModal')">
                Cancel
            </button>
            <button type="button" class="btn btn-primary" onclick="sendEmail()">
                <i class="ti ti-send"></i>
                Send Email
            </button>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-content">
        <div class="spinner"></div>
        <h3>Generating AI Proposal</h3>
        <p>Please wait while we create your personalized proposal...</p>
    </div>
</div>

<script>
    // =====================================================
    // GLOBAL VARIABLES
    // =====================================================
    let currentStep = 1;
    let proposalData = {};
    let quillEditor = null;
    let currentProposalId = null;

    const API_BASE = '/api/v1';

    // =====================================================
    // INITIALIZATION
    // =====================================================
    document.addEventListener('DOMContentLoaded', function () {
        console.log('Project Planner initialized');
        loadProposals();
        initializeEventListeners();
    });

    // =====================================================
    // EVENT LISTENERS
    // =====================================================
    function initializeEventListeners() {
        // Step 1 Form Submit
        const clientForm = document.getElementById('clientDetailsForm');
        if (clientForm) {
            clientForm.addEventListener('submit', handleClientFormSubmit);
        }
    }

    // =====================================================
    // TAB SWITCHING
    // =====================================================
    function switchTab(tabName) {
        // Update tab buttons
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        document.querySelector(`.tab-btn[data-tab="${tabName}"]`).classList.add('active');

        // Update tab content
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
        });
        document.getElementById(`tab-${tabName}`).classList.add('active');

        // Reset wizard if switching to create tab
        if (tabName === 'create' && currentStep !== 1) {
            resetWizard();
        }

        // Load proposals if switching to proposals tab
        if (tabName === 'proposals') {
            loadProposals();
        }
    }

    function showCreateTab() {
        switchTab('create');
        resetWizard();
    }

    // =====================================================
    // WIZARD NAVIGATION
    // =====================================================
    function goToStep(stepNumber) {
        // Validate current step before proceeding
        if (stepNumber > currentStep) {
            if (!validateCurrentStep()) {
                return;
            }
        }

        // Save editor content before leaving step 2
        if (currentStep === 2 && stepNumber !== 2 && quillEditor) {
            saveProposalContent();
        }

        // Hide current step
        document.querySelectorAll('.step-content').forEach(content => {
            content.classList.remove('active');
        });

        // Update stepper items
        document.querySelectorAll('.stepper-item').forEach((item, index) => {
            const step = index + 1;
            item.classList.remove('active', 'completed');

            if (step < stepNumber) {
                item.classList.add('completed');
            } else if (step === stepNumber) {
                item.classList.add('active');
            }
        });

        // Show new step
        document.getElementById(`step${stepNumber}`).classList.add('active');
        currentStep = stepNumber;

        // Update progress bar
        updateProgressBar();

        // Initialize step-specific features
        if (stepNumber === 2) {
            initializeEditor();
        } else if (stepNumber === 3) {
            populateProposalSummary();
        }

        // Scroll to top
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // =====================================================
    // SAVE PROPOSAL CONTENT
    // =====================================================
    async function saveProposalContent() {
        if (!currentProposalId || !quillEditor) {
            return;
        }

        try {
            const token = localStorage.getItem('access_token');
            if (!token) {
                return;
            }

            const content = quillEditor.root.innerHTML;

            const response = await fetch(`${API_BASE}/project-planner/proposals/${currentProposalId}/update-content`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    content: content
                })
            });

            const result = await response.json();

            if (result.success) {
                console.log('Proposal content saved');
            }
        } catch (error) {
            console.error('Error saving content:', error);
        }
    }

    function updateProgressBar() {
        const progress = document.getElementById('stepperProgress');
        if (progress) {
            const percentage = ((currentStep - 1) / 2) * 70; // 0%, 35%, 70%
            progress.style.width = `${percentage}%`;
        }
    }

    function validateCurrentStep() {
        if (currentStep === 1) {
            const form = document.getElementById('clientDetailsForm');
            return form.checkValidity();
        }
        return true;
    }

    function resetWizard() {
        currentStep = 1;
        proposalData = {};
        currentProposalId = null;

        // Reset form
        const form = document.getElementById('clientDetailsForm');
        if (form) {
            form.reset();

            // Re-enable all form inputs
            document.querySelectorAll('#clientDetailsForm input, #clientDetailsForm select, #clientDetailsForm textarea').forEach(input => {
                input.disabled = false;
            });
        }

        // Reset editor
        if (quillEditor) {
            quillEditor.setContents([]);
            quillEditor.enable(true); // Re-enable editor
        }

        // Show step 1
        goToStep(1);
    }


    // URL Validation Function - Fixed to properly handle all domains
    function validateURL(url) {
        if (!url || url.trim() === '') {
            return true; // Optional field, empty is okay
        }

        try {
            const urlObj = new URL(url);
            // Check if protocol is http or https
            return urlObj.protocol === 'http:' || urlObj.protocol === 'https:';
        } catch (e) {
            return false;
        }
    }

    // Add real-time URL validation
    document.addEventListener('DOMContentLoaded', function () {
        const websiteUrlInput = document.getElementById('websiteUrl');

        if (websiteUrlInput) {
            websiteUrlInput.addEventListener('blur', function () {
                const url = this.value.trim();

                if (url && !validateURL(url)) {
                    this.style.borderColor = '#dc3545';

                    // Show error message
                    let errorMsg = this.nextElementSibling;
                    // Skip the hint element
                    if (errorMsg && errorMsg.classList.contains('form-hint')) {
                        errorMsg = errorMsg.nextElementSibling;
                    }

                    if (!errorMsg || !errorMsg.classList.contains('url-error')) {
                        errorMsg = document.createElement('small');
                        errorMsg.className = 'url-error';
                        errorMsg.style.color = '#dc3545';
                        errorMsg.style.fontSize = '12px';
                        errorMsg.style.marginTop = '4px';
                        errorMsg.style.display = 'block';

                        // Insert after the hint text
                        const hint = this.parentNode.querySelector('.form-hint');
                        if (hint) {
                            hint.parentNode.insertBefore(errorMsg, hint.nextSibling);
                        } else {
                            this.parentNode.appendChild(errorMsg);
                        }
                    }
                    errorMsg.textContent = ' Please enter a valid URL starting with http:// or https://';
                } else {
                    this.style.borderColor = '';

                    // Remove error message
                    const errorMsg = this.parentNode.querySelector('.url-error');
                    if (errorMsg) {
                        errorMsg.remove();
                    }
                }
            });

            // Auto-add https:// if missing
            websiteUrlInput.addEventListener('change', function () {
                let url = this.value.trim();
                if (url && !url.match(/^https?:\/\//i)) {
                    this.value = 'https://' + url;
                    // Trigger blur to revalidate
                    this.dispatchEvent(new Event('blur'));
                }
            });
        }
    });
    // Update the form submission handler
    async function submitDiscoveryForm(e) {
        e.preventDefault();

        // Validate URL before submission
        const websiteUrl = document.getElementById('websiteUrl').value.trim();
        if (websiteUrl && !validateURL(websiteUrl)) {
            showNotification('Please enter a valid website URL', 'error');
            document.getElementById('websiteUrl').focus();
            return;
        }

        showLoading();

        try {
            // Collect form data
            const formData = new FormData(e.target);
            const existingPresence = {};

            // Collect checkboxes (simple true/false)
            document.querySelectorAll('input[type="checkbox"][name^="existing_"]').forEach(checkbox => {
                const key = checkbox.name.replace('existing_', '');
                existingPresence[key] = checkbox.checked;
            });

            // Build request payload
            const payload = {
                lead_name: formData.get('lead_name'),
                lead_email: formData.get('lead_email'),
                company_name: formData.get('company_name'),
                business_type: formData.get('business_type'),
                website_url: websiteUrl || null,
                budget: parseFloat(formData.get('budget')),
                target_audience: formData.get('target_audience'),
                challenges: formData.get('challenges'),
                existing_presence: existingPresence
            };

            console.log('Submitting proposal request:', payload);

            // Call API to generate proposal
            const token = localStorage.getItem('access_token');
            if (!token) {
                hideLoading();
                showNotification('Session expired. Please login again.', 'error');
                setTimeout(() => {
                    window.location.href = '/auth/login';
                }, 2000);
                return;
            }

            const response = await fetch(`${API_BASE}/project-planner/generate-proposal`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(payload)
            });

            const result = await response.json();

            if (!response.ok) {
                throw new Error(result.detail || result.message || 'Failed to generate proposal');
            }

            if (result.success) {
                // Store proposal data
                proposalData = result.proposal;
                currentProposalId = result.proposal_id;

                console.log('Proposal generated successfully:', result);

                // Show success notification
                showNotification('AI Strategy generated successfully!', 'success');

                // Move to step 2 after short delay
                setTimeout(() => {
                    hideLoading();
                    goToStep(2);
                    loadGeneratedContent(result.proposal);
                }, 1000);
            } else {
                hideLoading();
                showNotification(result.message || 'Failed to generate proposal', 'error');
            }
        } catch (error) {
            console.error('Error generating proposal:', error);
            hideLoading();
            showNotification(error.message || 'Failed to generate proposal. Please try again.', 'error');
        }
    }

    // Add this new function for retry functionality
    function showRetryDialog(errorMessage) {
        const dialogHTML = `
        <div class="retry-dialog-overlay" id="retryDialog">
            <div class="retry-dialog">
                <div class="retry-dialog-icon">
                    <i class="ti ti-alert-circle" style="font-size: 48px; color: #EF4444;"></i>
                </div>
                <h3>Proposal Generation Failed</h3>
                <p>${errorMessage}</p>
                <div class="retry-dialog-actions">
                    <button class="btn btn-secondary" onclick="closeRetryDialog()">
                        Cancel
                    </button>
                    <button class="btn btn-primary" onclick="retryProposalGeneration()">
                        <i class="ti ti-refresh"></i>
                        Try Again
                    </button>
                </div>
            </div>
        </div>
    `;

        document.body.insertAdjacentHTML('beforeend', dialogHTML);
    }

    function closeRetryDialog() {
        const dialog = document.getElementById('retryDialog');
        if (dialog) {
            dialog.remove();
        }
    }

    function retryProposalGeneration() {
        closeRetryDialog();
        // Get the form and submit it again
        const form = document.getElementById('clientDetailsForm');
        if (form) {
            submitDiscoveryForm({ preventDefault: () => { }, target: form });
        }
    }


    // =====================================================
    // STEP 1: CLIENT FORM HANDLING
    // =====================================================
    async function handleClientFormSubmit(e) {
        e.preventDefault();

        // Show loading
        showLoading();

        try {
            // Collect form data
            const formData = new FormData(e.target);
            const existingPresence = {};

            // Collect checkboxes
            document.querySelectorAll('input[type="checkbox"][name^="existing_"]').forEach(checkbox => {
                const key = checkbox.name.replace('existing_', '');
                existingPresence[key] = checkbox.checked;
            });

            // Build request payload
            const payload = {
                lead_name: formData.get('lead_name'),
                lead_email: formData.get('lead_email'),
                company_name: formData.get('company_name'),
                business_type: formData.get('business_type'),
                budget: parseFloat(formData.get('budget')),
                target_audience: formData.get('target_audience'),
                challenges: formData.get('challenges'),
                existing_presence: existingPresence
            };

            console.log('Submitting proposal request:', payload);

            // Call API to generate proposal
            const token = localStorage.getItem('access_token');
            if (!token) {
                window.location.href = '/auth/login';
                return;
            }

            const response = await fetch(`${API_BASE}/project-planner/generate-proposal`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(payload)
            });

            const result = await response.json();

            if (result.success) {
                // Store proposal data
                proposalData = result.proposal;
                currentProposalId = result.proposal_id;

                console.log('Proposal generated successfully:', result);

                // Show success notification
                showNotification('AI Strategy generated successfully!', 'success');

                // Move to step 2 after short delay
                setTimeout(() => {
                    hideLoading();
                    goToStep(2);
                    loadGeneratedContent(result.proposal);
                }, 1000);
            } else {
                hideLoading();
                showNotification(result.message || 'Failed to generate proposal', 'error');
            }
        } catch (error) {
            console.error('Error generating proposal:', error);
            hideLoading();
            showNotification('Failed to generate proposal. Please try again.', 'error');
        }
    }

    // =====================================================
    // STEP 2: RICH TEXT EDITOR
    // =====================================================
    function initializeEditor() {
        // Check if editor is already initialized
        if (quillEditor) {
            return;
        }

        // Show loading state
        document.getElementById('aiLoadingState').style.display = 'block';
        document.getElementById('editorContainer').style.display = 'none';

        // Initialize Quill editor after delay (simulating AI generation)
        setTimeout(() => {
            const toolbarOptions = [
                [{ 'font': [] }, { 'size': [] }],
                ['bold', 'italic', 'underline', 'strike'],
                [{ 'color': [] }, { 'background': [] }],
                [{ 'align': [] }],
                [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                [{ 'indent': '-1' }, { 'indent': '+1' }],
                [{ 'header': [1, 2, false] }],
                ['blockquote'],
                ['link', 'image'],
                ['clean']
            ];

            quillEditor = new Quill('#editor', {
                theme: 'snow',
                modules: {
                    toolbar: '#toolbar'
                },
                placeholder: 'AI-generated content will appear here...'
            });

            // Hide loading and show editor
            document.getElementById('aiLoadingState').style.display = 'none';
            document.getElementById('editorContainer').style.display = 'block';
            document.getElementById('step2Navigation').style.display = 'flex';

            console.log('Quill editor initialized');
        }, 500);
    }


    function loadGeneratedContent(proposal) {
        if (!quillEditor) {
            console.error('Editor not initialized');
            // Retry after a short delay if editor not ready
            setTimeout(() => loadGeneratedContent(proposal), 300);
            return;
        }

        console.log('=== LOADING GENERATED CONTENT ===');
        console.log('Raw proposal object:', proposal);

        // Check if there's edited content saved
        if (proposal.edited_content) {
            console.log('Loading previously edited content');
            quillEditor.clipboard.dangerouslyPasteHTML(proposal.edited_content);
            populateAIInsights(proposal.ai_generated_strategy || {}, proposal.competitive_differentiators || {});
            return;
        }

        // Parse JSON fields if they are strings
        let strategy = {};
        let differentiators = {};
        let timeline = {};
        let value_propositions = [];
        let competitive_analysis = {};
        let roi_simulation = {};

        try {
            strategy = typeof proposal.ai_generated_strategy === 'string'
                ? JSON.parse(proposal.ai_generated_strategy)
                : (proposal.ai_generated_strategy || {});
            console.log('Parsed strategy:', strategy);
            console.log('Strategy keys:', Object.keys(strategy));
        } catch (e) {
            console.error('Error parsing strategy:', e);
            strategy = {};
        }

        try {
            differentiators = typeof proposal.competitive_differentiators === 'string'
                ? JSON.parse(proposal.competitive_differentiators)
                : (proposal.competitive_differentiators || {});
            console.log('Parsed differentiators:', differentiators);
        } catch (e) {
            console.error('Error parsing differentiators:', e);
            differentiators = {};
        }

        try {
            timeline = typeof proposal.suggested_timeline === 'string'
                ? JSON.parse(proposal.suggested_timeline)
                : (proposal.suggested_timeline || {});
            console.log('Parsed timeline:', timeline);
        } catch (e) {
            console.error('Error parsing timeline:', e);
            timeline = {};
        }

        // NEW: Parse value propositions
        try {
            value_propositions = typeof proposal.value_propositions === 'string'
                ? JSON.parse(proposal.value_propositions)
                : (proposal.value_propositions || []);
            console.log('Parsed value_propositions:', value_propositions);
        } catch (e) {
            console.error('Error parsing value_propositions:', e);
            value_propositions = [];
        }

        // NEW: Parse competitive analysis
        try {
            competitive_analysis = typeof proposal.competitive_analysis === 'string'
                ? JSON.parse(proposal.competitive_analysis)
                : (proposal.competitive_analysis || {});
            console.log('Parsed competitive_analysis:', competitive_analysis);
        } catch (e) {
            console.error('Error parsing competitive_analysis:', e);
            competitive_analysis = {};
        }

        // NEW: Parse ROI simulation
        try {
            roi_simulation = typeof proposal.roi_simulation === 'string'
                ? JSON.parse(proposal.roi_simulation)
                : (proposal.roi_simulation || {});
            console.log('Parsed roi_simulation:', roi_simulation);
        } catch (e) {
            console.error('Error parsing roi_simulation:', e);
            roi_simulation = {};
        }

        console.log('=== CHECKING DATA AVAILABILITY ===');
        console.log('Campaigns:', strategy.campaigns || strategy.Recommended_Campaigns);
        console.log('Tools:', strategy.automation_tools || strategy.Automation_Tools);
        console.log('Company:', proposal.company_name || proposal.Company || strategy.Company);

        const content = generateProposalHTML(proposal, strategy, differentiators, timeline, value_propositions, competitive_analysis, roi_simulation);

        // Set content in editor
        quillEditor.clipboard.dangerouslyPasteHTML(content);

        // Populate AI Insights
        populateAIInsights(strategy, differentiators);

        console.log('=== CONTENT LOADED SUCCESSFULLY ===');
    }

    function generateProposalHTML(proposal, strategy, differentiators, timeline, value_propositions, competitive_analysis, roi_simulation) {

        console.log('=== GENERATING PROPOSAL HTML ===');
        console.log('Strategy:', strategy);
        console.log('ROI:', roi_simulation);

        console.log('=== GENERATING PROPOSAL HTML ===');
        console.log('Strategy:', strategy);

        // FIX: Unwrap nested roi_simulation if it exists
        if (roi_simulation && roi_simulation.roi_simulation) {
            roi_simulation = roi_simulation.roi_simulation;
        }

        console.log('Unwrapped ROI:', roi_simulation); // ADD THIS TO VERIFY



        // Extract data - checking capitalized keys first since that's what API returns
        const campaigns = strategy.Recommended_Campaigns || strategy.campaigns || [];
        const tools = strategy.Automation_Tools || strategy.automation_tools || [];
        const diffItems = differentiators.differentiators || [];
        const phases = timeline.phases || [];

        console.log('Campaigns found:', campaigns.length);
        console.log('Tools found:', tools.length);

        // Extract company name from multiple possible sources
        const companyName = proposal.company_name || strategy.Company || 'Your Company';

        // Build campaigns HTML
        const campaignsHTML = campaigns.length > 0
            ? campaigns.map(camp => {
                const type = camp.Type || camp.type || 'Campaign';
                const platform = camp.Platform || camp.platform || '';
                const platformText = Array.isArray(platform) ? platform.join(', ') : platform;
                const topics = camp.Content_Topics || camp.content_topics || [];
                const topicsText = Array.isArray(topics) ? topics.join(', ') : '';
                const budget = camp.Budget_Allocation_Percentage || '';

                let html = `<li><strong>${type}</strong>`;
                if (platformText) html += ` (${platformText})`;
                html += `: ${topicsText}`;
                if (budget) html += ` <em>(${budget}% of budget)</em>`;
                html += `</li>`;

                return html;
            }).join('')
            : '<li>AI-powered digital marketing campaigns tailored to your business needs</li>';

        // Build tools HTML
        const toolsHTML = tools.length > 0
            ? tools.map(tool => {
                const name = tool.Tool || tool.tool || tool.name || 'Marketing Tool';
                const purpose = tool.Purpose || tool.purpose || 'Campaign enhancement';
                const budget = tool.Budget_Allocation_Percentage || '';

                let html = `<li><strong>${name}:</strong> ${purpose}`;
                if (budget) html += ` <em>(${budget}% of budget)</em>`;
                html += `</li>`;

                return html;
            }).join('')
            : '<li>Marketing automation and analytics tools</li>';

        // Build differentiators HTML
        const diffHTML = diffItems.length > 0
            ? diffItems.map(diff => `
            <li>
                <strong>${diff.title}:</strong> ${diff.description}<br>
                <em>Impact: ${diff.impact}</em>
            </li>
          `).join('')
            : `<li><strong>AI-Powered Approach:</strong> Leveraging cutting-edge technology for optimal results<br><em>Impact: Increased efficiency and ROI</em></li>`;

        // NEW: Build value propositions HTML
        const valuePropsHTML = value_propositions && value_propositions.length > 0
            ? value_propositions.map(vp => `
            <div style="background: #f8f9ff; padding: 1.5rem; margin-bottom: 1rem; border-left: 4px solid #9926F3; border-radius: 8px;">
                <h4 style="color: #9926F3; margin-bottom: 0.5rem;">${vp.title || 'Value Proposition'}</h4>
                <p>${vp.description || ''}</p>
                <p><strong>Competitive Advantage:</strong> ${vp.competitive_advantage || 'N/A'}</p>
                <p><strong>Impact:</strong> ${vp.impact || 'N/A'}</p>
            </div>
          `).join('')
            : '';

        // NEW: Build competitive analysis HTML
        const competitiveHTML = competitive_analysis && (competitive_analysis.opportunities || competitive_analysis.threats)
            ? `
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 2rem;">
                <div style="background: #e8f5e9; padding: 1.5rem; border-radius: 8px;">
                    <h4 style="color: #2e7d32; margin-top: 0;"> Opportunities</h4>
                    <ul style="margin: 0; padding-left: 1.5rem;">
                        ${(competitive_analysis.opportunities || []).map(o => `<li>${o}</li>`).join('')}
                    </ul>
                </div>
                <div style="background: #ffebee; padding: 1.5rem; border-radius: 8px;">
                    <h4 style="color: #c62828; margin-top: 0;"> Threats</h4>
                    <ul style="margin: 0; padding-left: 1.5rem;">
                        ${(competitive_analysis.threats || []).map(t => `<li>${t}</li>`).join('')}
                    </ul>
                </div>
            </div>
          `
            : '';

        // NEW: Build ROI simulation HTML
        const roiHTML = roi_simulation
            ? `
        <div style="background: linear-gradient(135deg, #9926F3, #1DD8FC); color: white; padding: 2rem; border-radius: 12px; margin-bottom: 2rem;">
            <h3 style="margin: 0 0 1.5rem 0; color: white; text-align: center; font-size: 1.5rem;">Key Metrics - Year 1</h3>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 2rem; text-align: center; margin-bottom: 2rem;">
                <div>
                    <h3 style="font-size: 2.5rem; margin: 0; color: white;">${roi_simulation.expected_leads?.month_12 || 0}</h3>
                    <p style="margin: 0.5rem 0 0; color: white; opacity: 0.95; color:blue">Expected Leads</p>
                </div>
                <div>
                    <h3 style="font-size: 2.5rem; margin: 0; color: white;">${roi_simulation.cost_per_lead?.average?.toFixed(2) || 0}</h3>
                    <p style="margin: 0.5rem 0 0; color: white; opacity: 0.95;">Avg Cost Per Lead</p>
                </div>
                <div>
                    <h3 style="font-size: 2.5rem; margin: 0; color: white;">${roi_simulation.conversion_rate || 0}%</h3>
                    <p style="margin: 0.5rem 0 0; color: white; opacity: 0.95;">Conversion Rate</p>
                </div>
                <div>
                    <h3 style="font-size: 2.5rem; margin: 0; color: white;">${(roi_simulation.estimated_revenue?.month_12 || 0).toLocaleString()}</h3>
                    <p style="margin: 0.5rem 0 0; color: white; opacity: 0.95;">Estimated Revenue</p>
                </div>
            </div>
            
            <div style="background: rgba(255,255,255,0.15); padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                <h4 style="margin: 0 0 1rem 0; color: white; font-size: 1.1rem;">Monthly Progression</h4>
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; text-align: center;">
                    <div>
                        <p style="margin: 0; font-size: 0.875rem; opacity: 0.9;">Month 1</p>
                        <p style="margin: 0.25rem 0 0; font-weight: 600;">${roi_simulation.expected_leads?.month_1 || 0} leads</p>
                        <p style="margin: 0; font-size: 0.875rem;">${(roi_simulation.estimated_revenue?.month_1 || 0).toLocaleString()}</p>
                    </div>
                    <div>
                        <p style="margin: 0; font-size: 0.875rem; opacity: 0.9;">Month 3</p>
                        <p style="margin: 0.25rem 0 0; font-weight: 600;">${roi_simulation.expected_leads?.month_3 || 0} leads</p>
                        <p style="margin: 0; font-size: 0.875rem;">${(roi_simulation.estimated_revenue?.month_3 || 0).toLocaleString()}</p>
                    </div>
                    <div>
                        <p style="margin: 0; font-size: 0.875rem; opacity: 0.9;">Month 6</p>
                        <p style="margin: 0.25rem 0 0; font-weight: 600;">${roi_simulation.expected_leads?.month_6 || 0} leads</p>
                        <p style="margin: 0; font-size: 0.875rem;">${(roi_simulation.estimated_revenue?.month_6 || 0).toLocaleString()}</p>
                    </div>
                    <div>
                        <p style="margin: 0; font-size: 0.875rem; opacity: 0.9;">Month 12</p>
                        <p style="margin: 0.25rem 0 0; font-weight: 600;">${roi_simulation.expected_leads?.month_12 || 0} leads</p>
                        <p style="margin: 0; font-size: 0.875rem;">${(roi_simulation.estimated_revenue?.month_12 || 0).toLocaleString()}</p>
                    </div>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                <div style="background: rgba(255,255,255,0.15); padding: 1rem; border-radius: 8px;">
                    <h4 style="margin: 0 0 0.5rem 0; color: white; font-size: 1rem;">Cost Per Lead Scenarios</h4>
                    <p style="margin: 0.25rem 0; font-size: 0.875rem;">Best Case: ${roi_simulation.cost_per_lead?.best_case?.toFixed(2) || 0}</p>
                    <p style="margin: 0.25rem 0; font-size: 0.875rem;">Average: ${roi_simulation.cost_per_lead?.average?.toFixed(2) || 0}</p>
                    <p style="margin: 0.25rem 0; font-size: 0.875rem;">Worst Case: ${roi_simulation.cost_per_lead?.worst_case?.toFixed(2) || 0}</p>
                </div>
                <div style="background: rgba(255,255,255,0.15); padding: 1rem; border-radius: 8px;">
                    <h4 style="margin: 0 0 0.5rem 0; color: white; font-size: 1rem;">ROI Timeline</h4>
                    <p style="margin: 0.25rem 0; font-size: 0.875rem;">Expected Customers: ${roi_simulation.estimated_customers?.month_12 || 0}</p>
                    <p style="margin: 0.25rem 0; font-size: 0.875rem;">ROI by Year 1: ${roi_simulation.roi_percentage?.month_12 || 0}%</p>
                    <p style="margin: 0.25rem 0; font-size: 0.875rem;">Breakeven: ${roi_simulation.timeframe_to_roi || 'N/A'} months</p>
                </div>
            </div>
        </div>
      `
            : '';

        // Build timeline HTML
        const timelineHTML = phases.length > 0
            ? phases.map((phase, idx) => `
            <h3><strong>Phase ${idx + 1}: ${phase.phase || phase.name || `Phase ${idx + 1}`}</strong></h3>
            <p><strong>Duration:</strong> ${phase.duration}</p>
            <p><strong>Key Deliverables:</strong></p>
            <ul>
                ${(phase.deliverables || []).map(del => `<li>${del}</li>`).join('')}
            </ul>
          `).join('')
            : `<h3><strong>Phase 1: Planning & Setup</strong></h3><p><strong>Duration:</strong> 2-4 weeks</p><ul><li>Initial strategy development</li></ul>`;

        const challenges = proposal.challenges || (strategy.Challenges ? strategy.Challenges.join(', ') : 'Enhancing digital presence');
        const targetAudience = proposal.target_audience || strategy.Target_Audience || 'Target market segments';
        const budget = proposal.budget || strategy.Budget || 0;
        const businessType = proposal.business_type || strategy.Business_Type || 'organization';

        return `
        <h1 style="text-align: center; color: #9926F3;">Digital Marketing Proposal</h1>
        <h2 style="text-align: center; color: #1DD8FC;">for ${companyName}</h2>
        <p style="text-align: center; margin-bottom: 2rem;"><em>Prepared by PanvelIQ</em></p>
        
        <hr style="margin: 2rem 0;">
        
        <h2><strong>Executive Summary</strong></h2>
        <p>This comprehensive digital marketing proposal has been specifically designed for <strong>${companyName}</strong>, a ${businessType} looking to enhance their digital presence and drive measurable growth.</p>
        <p>Our AI-powered approach combines cutting-edge marketing technology with proven strategies to deliver exceptional results within your investment budget of <strong>${budget.toLocaleString()}</strong>.</p>
        
        <h2><strong>Current Challenges</strong></h2>
        <p>${challenges}</p>
        
        <h2><strong>Target Audience Analysis</strong></h2>
        <p>${targetAudience}</p>
        
        <h2><strong>Recommended Marketing Strategy</strong></h2>
        <p>Based on our AI analysis, we recommend a comprehensive marketing approach across multiple channels.</p>
        
        <h3><strong>Recommended Campaigns</strong></h3>
        <ul>
            ${campaignsHTML}
        </ul>

        <br>
        
        <h3><strong>Automation Tools & Technologies</strong></h3>
        <ul>
            ${toolsHTML}
        </ul>
        
        <h2><strong>Competitive Differentiators</strong></h2>
        <p>What sets our approach apart:</p>
        <ul>
            ${diffHTML}
        </ul>
        
        ${valuePropsHTML ? `
        <h2><strong>Unique Value Propositions</strong></h2>
        ${valuePropsHTML}
        ` : ''}

        <br>
        
        ${competitiveHTML ? `
        <h2><strong>Competitive Analysis</strong></h2>
        ${competitiveHTML}
        ` : ''}
        <br>
        
        ${roiHTML ? `
        <h2><strong>ROI Simulation: "If you spend ${budget.toLocaleString()}, expect..."</strong></h2>
        ${roiHTML}
        ` : ''}
        
        <br>

        <h2><strong>Project Timeline</strong></h2>
        ${timelineHTML}
        
        <hr style="margin: 2rem 0;">
        
        <br>
        
        <h2><strong>Next Steps</strong></h2>
        <ol>
            <li>Review this proposal and provide feedback</li>
            <li>Schedule a strategy session to discuss implementation</li>
            <li>Finalize project scope and timeline</li>
            <li>Begin Phase 1 execution</li>
        </ol>
        
        <hr style="margin: 2rem 0;">
        
        <p style="text-align: center;"><strong>We look forward to partnering with you to achieve exceptional marketing results!</strong></p>
        <p style="text-align: center;"><em>Contact: info@panveliq.com | www.panveliq.com</em></p>
    `;
    }


    function populateAIInsights(strategy, differentiators) {
        const insightsContainer = document.getElementById('aiInsightsContent');
        if (!insightsContainer) return;

        const insights = [
            {
                title: 'Budget Optimization',
                icon: 'currency-dollar',
                content: 'AI recommends allocating 40% to paid advertising, 30% to content creation, 20% to SEO, and 10% to analytics tools for optimal ROI.'
            },
            {
                title: 'Platform Priority',
                icon: 'chart-line',
                content: `Focus on ${strategy.platforms ? strategy.platforms.join(', ') : 'social media, search, and email marketing'} based on your target audience demographics and behavior patterns.`
            },
            {
                title: 'Timeline Recommendation',
                icon: 'clock',
                content: 'Expected to see initial results in 30-45 days, with full campaign optimization achieved by month 3.'
            },
            {
                title: 'Key Success Metrics',
                icon: 'target',
                content: 'Track: Website traffic (+50%), Lead generation (+40%), Conversion rate (+25%), Social engagement (+60%).'
            }
        ];

        insightsContainer.innerHTML = insights.map(insight => `
        <div class="ai-insight-item">
            <div class="insight-title">
                <i class="ti ti-${insight.icon}"></i>
                ${insight.title}
            </div>
            <div class="insight-content">${insight.content}</div>
        </div>
    `).join('');
    }

    // =====================================================
    // STEP 3: EXPORT & SHARE
    // =====================================================
    function populateProposalSummary() {
        const container = document.getElementById('proposalSummaryContent');
        if (!container || !proposalData) return;

        const summary = [
            { label: 'Company', value: proposalData.company_name || 'N/A', icon: 'building' },
            { label: 'Business Type', value: proposalData.business_type || 'N/A', icon: 'briefcase' },
            { label: 'Budget', value: `${(proposalData.budget || 0).toLocaleString()}`, icon: 'currency-dollar' },
            { label: 'Contact', value: proposalData.full_name || 'N/A', icon: 'user' },
            { label: 'Email', value: proposalData.lead_email || 'N/A', icon: 'mail' },
            { label: 'Status', value: 'Draft', icon: 'file' }
        ];

        container.innerHTML = summary.map(item => `
        <div class="summary-item">
            <span class="summary-label">
                <i class="ti ti-${item.icon}"></i> ${item.label}
            </span>
            <span class="summary-value">${item.value}</span>
        </div>
    `).join('');
    }

    // =====================================================
    // EXPORT FUNCTIONS
    // =====================================================
    async function exportProposal(format) {
        if (!currentProposalId) {
            showNotification('Please generate a proposal first', 'error');
            return;
        }

        showLoading();

        try {

            const token = localStorage.getItem('access_token');
            const response = await fetch(`${API_BASE}/project-planner/proposals/${currentProposalId}/export/pdf`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            if (response.ok) {
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `proposal_${currentProposalId}.pdf`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

                showNotification('Proposal exported successfully!', 'success');
            } else {
                throw new Error('Export failed');
            }
        } catch (error) {
            console.error('Export error:', error);
            showNotification('Failed to export proposal', 'error');
        } finally {
            hideLoading();
        }
    }

    async function generateShareLink() {
        if (!currentProposalId) {
            showNotification('Please generate a proposal first', 'error');
            return;
        }

        showLoading();

        try {
            const token = localStorage.getItem('access_token');
            const response = await fetch(`${API_BASE}/project-planner/proposals/${currentProposalId}/generate-link`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            const result = await response.json();

            if (result.success) {
                document.getElementById('generatedLink').value = result.share_link;
                document.getElementById('shareLinkResult').style.display = 'block';
                showNotification('Share link generated!', 'success');
            } else {
                throw new Error(result.message || 'Failed to generate link');
            }
        } catch (error) {
            console.error('Share link error:', error);
            showNotification('Failed to generate share link', 'error');
        } finally {
            hideLoading();
        }
    }

    function copyShareLink() {
        const input = document.getElementById('generatedLink');
        input.select();
        document.execCommand('copy');
        showNotification('Link copied to clipboard!', 'success');
    }

    function openEmailModal() {
        if (!currentProposalId) {
            showNotification('Please generate a proposal first', 'error');
            return;
        }

        // Pre-fill recipient email
        const emailInput = document.getElementById('recipientEmail');
        if (emailInput && proposalData.lead_email) {
            emailInput.value = proposalData.lead_email;
        }

        document.getElementById('emailModal').classList.add('active');
    }

    function closeModal(modalId) {
        document.getElementById(modalId).classList.remove('active');
    }


    // ============================================
    // FIX: Replace the sendEmail() function in static/js/project-planner.js
    // The issue is missing Authorization header
    // ============================================


    async function sendEmail() {
        const recipientEmail = document.getElementById('recipientEmail').value;
        const subject = document.getElementById('emailSubject').value;
        const message = document.getElementById('emailMessage').value;

        if (!recipientEmail || !subject || !message) {
            showNotification('Please fill in all fields', 'error');
            return;
        }

        const token = localStorage.getItem('access_token');
        if (!token) {
            showNotification('Session expired. Please login again.', 'error');
            window.location.href = '/auth/login';
            return;
        }

        showLoading();
        closeModal('emailModal');

        try {
            const response = await fetch(`${API_BASE}/project-planner/proposals/${currentProposalId}/send-email`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    recipient_email: recipientEmail,
                    subject: subject,
                    message: message
                })
            });

            const result = await response.json();

            if (result.success) {
                showNotification('Proposal sent via email successfully!', 'success');
            } else {
                throw new Error(result.message || result.detail || 'Failed to send email');
            }
        } catch (error) {
            console.error('Email error:', error);
            showNotification('Failed to send email: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }


    async function sendToDashboard() {
        if (!currentProposalId) {
            showNotification('Please generate a proposal first', 'error');
            return;
        }

        showLoading();

        try {
            const token = localStorage.getItem('access_token');
            if (!token) {
                hideLoading();
                showNotification('Session expired. Please login again.', 'error');
                setTimeout(() => {
                    window.location.href = '/auth/login';
                }, 2000);
                return;
            }

            const response = await fetch(`${API_BASE}/project-planner/proposals/${currentProposalId}/send-to-dashboard`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                }
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Failed to send to dashboard');
            }

            const result = await response.json();

            if (result.success) {
                // Show success message
                showNotification('Proposal added to client dashboard!', 'success');

                // Update UI to show proposal was sent
                setTimeout(() => {
                    hideLoading();
                    showSuccessDialog();
                }, 500);
            } else {
                throw new Error(result.message || 'Failed to send to dashboard');
            }
        } catch (error) {
            console.error('Dashboard error:', error);
            hideLoading();
            showNotification(error.message || 'Failed to send to dashboard', 'error');
        }
    }

    // Add success dialog function
    function showSuccessDialog() {
        const dialogHTML = `
        <div class="success-dialog-overlay" id="successDialog">
            <div class="success-dialog">
                <div class="success-dialog-icon">
                    <i class="ti ti-circle-check" style="font-size: 64px; color: #10B981;"></i>
                </div>
                <h3>Proposal Sent Successfully!</h3>
                <p>The proposal has been added to the client's dashboard. They will receive a notification to review it.</p>
                <div class="success-dialog-details">
                    <div class="detail-item">
                        <i class="ti ti-check"></i>
                        <span>Client notified</span>
                    </div>
                    <div class="detail-item">
                        <i class="ti ti-check"></i>
                        <span>Added to dashboard</span>
                    </div>
                    <div class="detail-item">
                        <i class="ti ti-check"></i>
                        <span>Ready for review</span>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="closeSuccessDialog()">
                    Done
                </button>
            </div>
        </div>
    `;

        document.body.insertAdjacentHTML('beforeend', dialogHTML);
    }

    function closeSuccessDialog() {
        const dialog = document.getElementById('successDialog');
        if (dialog) {
            dialog.remove();
        }
        // Optionally redirect to proposals list
        setTimeout(() => {
            switchTab('proposals');
            loadProposals();
        }, 500);
    }



    function finishProposal() {
        showNotification('Proposal completed successfully!', 'success');

        // Reload proposals list
        setTimeout(() => {
            switchTab('proposals');
            resetWizard();
        }, 1500);
    }

    // =====================================================
    // LOAD PROPOSALS (ALL TAB)
    // =====================================================
    async function loadProposals() {
        const container = document.getElementById('proposalsContainer');
        if (!container) return;

        container.innerHTML = '<div class="loading-state"><div class="loader-spinner"></div><p>Loading proposals...</p></div>';

        try {
            const token = localStorage.getItem('access_token');
            if (!token) {
                window.location.href = '/auth/login';
                return;
            }

            const response = await fetch(`${API_BASE}/project-planner/proposals/list`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            const result = await response.json();

            if (result.success && result.proposals.length > 0) {
                container.innerHTML = `
                <div class="proposals-grid">
                    ${result.proposals.map(proposal => createProposalCard(proposal)).join('')}
                </div>
            `;
            } else {
                container.innerHTML = `
                <div class="empty-state">
                    <i class="ti ti-file-off"></i>
                    <h3>No Proposals Yet</h3>
                    <p>Create your first AI-powered marketing proposal</p>
                    <button class="btn btn-primary" onclick="showCreateTab()">
                        Create New Proposal
                    </button>
                </div>
            `;
            }
        } catch (error) {
            console.error('Error loading proposals:', error);
            container.innerHTML = `
            <div class="empty-state">
                <i class="ti ti-alert-circle"></i>
                <h3>Error Loading Proposals</h3>
                <p>Please try again later</p>
            </div>
        `;
        }
    }

    function createProposalCard(proposal) {
        const statusClass = `status-${proposal.status.toLowerCase()}`;
        const createdDate = new Date(proposal.created_at).toLocaleDateString();

        return `
        <div class="proposal-card">
            <div class="proposal-header">
                <div class="proposal-client">
                    <h3>${proposal.company_name || 'Untitled'}</h3>
                    <p>${proposal.business_type}</p>
                </div>
                <span class="status-badge ${statusClass}">${proposal.status}</span>
            </div>
            
            <div class="proposal-details">
                <div class="detail-item">
                    <span class="detail-label">
                        <i class="ti ti-currency-dollar"></i>
                        Budget
                    </span>
                    <span class="detail-value">${(proposal.budget || 0).toLocaleString()}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">
                        <i class="ti ti-user"></i>
                        Contact
                    </span>
                    <span class="detail-value">${proposal.client_name || 'N/A'}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">
                        <i class="ti ti-calendar"></i>
                        Created
                    </span>
                    <span class="detail-value">${createdDate}</span>
                </div>
            </div>
            
            <div class="proposal-actions">
                <button class="btn btn-sm btn-primary" onclick="viewProposal(${proposal.proposal_id})">
                    <i class="ti ti-eye"></i>
                    View
                </button>
                <button class="btn btn-sm btn-outline" onclick="editProposal(${proposal.proposal_id})">
                    <i class="ti ti-edit"></i>
                    Edit
                </button>
                <button class="btn btn-sm btn-outline" onclick="deleteProposal(${proposal.proposal_id})" style="color: #EF4444; border-color: #EF4444;">
                    <i class="ti ti-trash"></i>
                    Delete
                </button>
            </div>
        </div>
    `;
    }



    // =====================================================
    // PROPOSAL ACTIONS
    // =====================================================
    async function viewProposal(proposalId) {
        showLoading();

        try {
            const token = localStorage.getItem('access_token');
            if (!token) {
                window.location.href = '/auth/login';
                return;
            }

            // Fetch proposal details
            const response = await fetch(`${API_BASE}/project-planner/proposals/${proposalId}`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            const result = await response.json();

            if (result.success && result.proposal) {
                // Store proposal data
                proposalData = result.proposal;
                currentProposalId = proposalId;

                // Switch to create tab in view mode
                switchTab('create');

                // Populate form with existing data (read-only)
                populateEditForm(result.proposal);

                // Disable form inputs for view mode
                document.querySelectorAll('#clientDetailsForm input, #clientDetailsForm select, #clientDetailsForm textarea').forEach(input => {
                    input.disabled = true;
                });

                // Go directly to step 2 to show content
                setTimeout(() => {
                    goToStep(2);
                    loadGeneratedContent(result.proposal);

                    // Make editor read-only
                    if (quillEditor) {
                        quillEditor.enable(false);
                    }

                    hideLoading();
                    showNotification('Viewing proposal in read-only mode', 'info');
                }, 500);
            } else {
                throw new Error(result.message || 'Failed to load proposal');
            }
        } catch (error) {
            console.error('View error:', error);
            showNotification('Failed to load proposal details', 'error');
            hideLoading();
        }
    }

    async function editProposal(proposalId) {
        showLoading();

        try {
            const token = localStorage.getItem('access_token');
            if (!token) {
                window.location.href = '/auth/login';
                return;
            }

            // Fetch proposal details
            const response = await fetch(`${API_BASE}/project-planner/proposals/${proposalId}`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            const result = await response.json();

            if (result.success && result.proposal) {
                // Store proposal data
                proposalData = result.proposal;
                currentProposalId = proposalId;

                // Switch to create tab
                switchTab('create');

                // Populate form with existing data
                populateEditForm(result.proposal);

                // Go to step 2 with editor
                setTimeout(() => {
                    goToStep(2);
                    loadGeneratedContent(result.proposal);
                    hideLoading();
                }, 500);

                showNotification('Proposal loaded for editing', 'success');
            } else {
                throw new Error(result.message || 'Failed to load proposal');
            }
        } catch (error) {
            console.error('Edit error:', error);
            showNotification('Failed to load proposal for editing', 'error');
            hideLoading();
        }
    }

    function populateEditForm(proposal) {
        // Populate form fields
        document.getElementById('leadName').value = proposal.lead_name || '';
        document.getElementById('leadEmail').value = proposal.lead_email || '';
        document.getElementById('companyName').value = proposal.company_name || '';
        document.getElementById('businessType').value = proposal.business_type || '';
        document.getElementById('budget').value = proposal.budget || '';
        document.getElementById('targetAudience').value = proposal.target_audience || '';
        document.getElementById('challenges').value = proposal.challenges || '';

        // Populate checkboxes for existing presence
        const existingPresence = proposal.existing_presence || {};
        Object.keys(existingPresence).forEach(key => {
            const checkbox = document.querySelector(`input[name="existing_${key}"]`);
            if (checkbox) {
                checkbox.checked = existingPresence[key];
            }
        });
    }

    async function deleteProposal(proposalId) {
        if (!confirm('Are you sure you want to delete this proposal?')) {
            return;
        }

        showLoading();

        try {
            const token = localStorage.getItem('access_token');
            const response = await fetch(`${API_BASE}/project-planner/proposals/${proposalId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            const result = await response.json();

            if (result.success) {
                showNotification('Proposal deleted successfully', 'success');
                loadProposals();
            } else {
                throw new Error(result.message || 'Failed to delete');
            }
        } catch (error) {
            console.error('Delete error:', error);
            showNotification('Failed to delete proposal', 'error');
        } finally {
            hideLoading();
        }
    }

    // =====================================================
    // UTILITY FUNCTIONS
    // =====================================================
    function showLoading() {
        document.getElementById('loadingOverlay').classList.add('active');
    }

    function hideLoading() {
        document.getElementById('loadingOverlay').classList.remove('active');
    }

    function showNotification(message, type = 'info') {
        const colors = {
            success: '#10B981',
            error: '#EF4444',
            info: '#3B82F6',
            warning: '#F59E0B'
        };

        const icons = {
            success: 'check-circle',
            error: 'alert-circle',
            info: 'info-circle',
            warning: 'alert-triangle'
        };

        const notification = document.createElement('div');
        notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${colors[type]};
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 12px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        z-index: 10000;
        animation: slideIn 0.3s ease;
        max-width: 400px;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    `;

        notification.innerHTML = `
        <i class="ti ti-${icons[type]}" style="font-size: 1.5rem;"></i>
        <span>${message}</span>
    `;

        document.body.appendChild(notification);

        setTimeout(() => {
            notification.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    }

    // =====================================================
    // ANIMATIONS
    // =====================================================
    const style = document.createElement('style');
    style.textContent = `
    @keyframes slideIn {
        from {
            transform: translateX(400px);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    @keyframes slideOut {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(400px);
            opacity: 0;
        }
    }
`;
    document.head.appendChild(style);


    function toggleUrlField(platform) {
        const checkbox = document.getElementById(`existing_${platform}`);
        const urlField = document.getElementById(`url_${platform}`);

        if (urlField) {
            urlField.style.display = checkbox.checked ? 'block' : 'none';
            urlField.required = checkbox.checked;
            if (!checkbox.checked) {
                urlField.value = '';
            }
        }
    }
</script>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<!-- <script src="/static/js/project-planner.js?v=7"></script> -->
{% endblock %}