{% extends "base.html" %}

{% block title %}Smart SEO Toolkit - PanvelIQ{% endblock %}

{% block extra_css %}
<style>
    .seo-container {
        padding: 2rem;
        max-width: 1400px;
        margin: 0 auto;
    }

    .header-hero {
        background: linear-gradient(135deg, #9926F3, #1DD8FC);
        border-radius: 16px;
        padding: 2rem;
        margin-bottom: 2rem;
        color: white;
    }

    .header-hero h1 {
        margin: 0 0 0.5rem 0;
        font-size: 1.75rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .header-hero p {
        margin: 0;
        opacity: 0.9;
    }

    /* Tabs */
    .seo-tabs {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
        border-bottom: 2px solid #e9ecef;
        padding-bottom: 0.5rem;
    }

    .seo-tab {
        padding: 0.75rem 1.25rem;
        border: none;
        background: transparent;
        cursor: pointer;
        border-radius: 8px 8px 0 0;
        font-weight: 500;
        color: #6c757d;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.2s;
    }

    .seo-tab:hover {
        background: #f8f9fa;
        color: #333;
    }

    .seo-tab.active {
        background: linear-gradient(135deg, #9926F3, #1DD8FC);
        color: white;
    }

    .seo-tab-content {
        display: none;
    }

    .seo-tab-content.active {
        display: block;
    }

    /* Cards */
    .seo-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        margin-bottom: 1.5rem;
    }

    .seo-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .seo-card-title {
        margin: 0 0 1rem 0;
        font-size: 1.125rem;
        color: #333;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    /* Score Cards Grid */
    .scores-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .score-card {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 1.25rem;
        text-align: center;
        border: 1px solid #e9ecef;
        transition: transform 0.2s;
    }

    .score-card:hover {
        transform: translateY(-2px);
    }

    .score-card-label {
        font-size: 0.8rem;
        color: #6c757d;
        margin-bottom: 0.5rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .score-card-value {
        font-size: 2rem;
        font-weight: 700;
    }

    .score-card-value.excellent {
        color: #28a745;
    }

    .score-card-value.good {
        color: #17a2b8;
    }

    .score-card-value.warning {
        color: #ffc107;
    }

    .score-card-value.danger {
        color: #dc3545;
    }

    .score-card-subtitle {
        font-size: 0.75rem;
        color: #6c757d;
        margin-top: 0.25rem;
    }

    /* Progress Ring */
    .progress-ring {
        width: 80px;
        height: 80px;
        margin: 0 auto 0.5rem;
    }

    .progress-ring-circle {
        transition: stroke-dashoffset 0.5s ease-in-out;
        transform: rotate(-90deg);
        transform-origin: 50% 50%;
    }

    /* Forms */
    .form-group {
        margin-bottom: 1rem;
    }

    .form-label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
        color: #333;
    }

    .form-control {
        width: 100%;
        padding: 0.75rem 1rem;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        font-size: 0.9375rem;
        transition: border-color 0.2s;
    }

    .form-control:focus {
        outline: none;
        border-color: #9926F3;
        box-shadow: 0 0 0 3px rgba(153, 38, 243, 0.1);
    }

    .form-control-textarea {
        min-height: 150px;
        resize: vertical;
    }

    /* Buttons */
    .btn-primary {
        background: linear-gradient(135deg, #9926F3, #1DD8FC);
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.2s;
    }

    .btn-primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(153, 38, 243, 0.3);
    }

    .btn-primary:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    .btn-secondary {
        background: #6c757d;
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 6px;
        cursor: pointer;
    }

    .btn-sm {
        padding: 0.4rem 0.8rem;
        font-size: 0.875rem;
    }

    /* Tables */
    .data-table {
        width: 100%;
        border-collapse: collapse;
    }

    .data-table th {
        background: linear-gradient(135deg, #9926F3, #1DD8FC);
        color: white;
        padding: 1rem;
        text-align: left;
        font-weight: 600;
    }

    .data-table td {
        padding: 1rem;
        border-bottom: 1px solid #e9ecef;
    }

    .data-table tr:hover {
        background: #f8f9fa;
    }

    /* Badges */
    .badge {
        display: inline-block;
        padding: 0.35rem 0.75rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
    }

    .badge-success {
        background: #28a745;
        color: white;
    }

    .badge-warning {
        background: #ffc107;
        color: #000;
    }

    .badge-danger {
        background: #dc3545;
        color: white;
    }

    .badge-info {
        background: #17a2b8;
        color: white;
    }

    .badge-secondary {
        background: #6c757d;
        color: white;
    }

    /* Position Badge */
    .position-badge {
        display: inline-block;
        padding: 0.375rem 0.75rem;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.875rem;
    }

    .position-badge.top-10 {
        background: #28a745;
        color: white;
    }

    .position-badge.top-50 {
        background: #ffc107;
        color: #000;
    }

    .position-badge.beyond {
        background: #6c757d;
        color: white;
    }

    /* Trend Indicators */
    .trend-up {
        color: #28a745;
    }

    .trend-down {
        color: #dc3545;
    }

    .trend-stable {
        color: #6c757d;
    }

    /* Issues List */
    .issues-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .issue-item {
        padding: 1rem;
        border-left: 4px solid;
        margin-bottom: 0.75rem;
        background: #f8f9fa;
        border-radius: 0 8px 8px 0;
    }

    .issue-item.high {
        border-color: #dc3545;
    }

    .issue-item.medium {
        border-color: #ffc107;
    }

    .issue-item.low {
        border-color: #17a2b8;
    }

    .issue-category {
        font-weight: 600;
        color: #333;
        margin-bottom: 0.25rem;
    }

    .issue-text {
        color: #666;
        margin-bottom: 0.25rem;
    }

    .issue-recommendation {
        font-size: 0.875rem;
        color: #28a745;
    }

    /* Targets Grid */
    .targets-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1rem;
    }

    .target-card {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 1.25rem;
        border: 1px solid #e9ecef;
    }

    .target-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 0.75rem;
    }

    .target-type {
        font-weight: 600;
        color: #333;
    }

    .target-da {
        font-weight: 700;
        font-size: 1.25rem;
    }

    .target-da.high {
        color: #28a745;
    }

    .target-da.medium {
        color: #ffc107;
    }

    .target-da.low {
        color: #dc3545;
    }

    .target-description {
        color: #666;
        font-size: 0.9rem;
        margin-bottom: 0.75rem;
    }

    .target-strategy {
        font-size: 0.85rem;
        color: #17a2b8;
    }

    /* Core Web Vitals */
    .cwv-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
    }

    .cwv-item {
        text-align: center;
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 8px;
    }

    .cwv-label {
        font-size: 0.75rem;
        color: #6c757d;
        text-transform: uppercase;
    }

    .cwv-value {
        font-size: 1.5rem;
        font-weight: 700;
        margin: 0.5rem 0;
    }

    .cwv-unit {
        font-size: 0.75rem;
        color: #6c757d;
    }

    /* Loading */
    .loading-spinner {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: white;
        animation: spin 1s linear infinite;
        margin-left: 0.5rem;
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 3rem 2rem;
        color: #6c757d;
    }

    .empty-state i {
        font-size: 3rem;
        color: #dee2e6;
        margin-bottom: 1rem;
        display: block;
    }

    /* Two Column Layout */
    .two-col {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.5rem;
    }

    @media (max-width: 992px) {
        .two-col {
            grid-template-columns: 1fr;
        }
    }

    /* Modal */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }

    .modal-overlay.active {
        display: flex;
    }

    .modal-content {
        background: white;
        border-radius: 16px;
        padding: 2rem;
        max-width: 500px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
    }

    .modal-title {
        font-size: 1.25rem;
        font-weight: 600;
        margin: 0;
    }

    .modal-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: #6c757d;
    }


    /* Add this to the <style> block in templates/modules/seo.html */

    /* Competitor Input Groups */
    .competitor-input-group {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
    }

    .competitor-input-group .form-control {
        flex: 1;
    }

    .btn-icon-remove {
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 8px;
        padding: 0.5rem 0.75rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s;
    }

    .btn-icon-remove:hover {
        background: #c82333;
    }

    /* Gap Analysis Cards */
    .gaps-summary {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1rem;
    }

    .gap-card {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 1.25rem;
        border-left: 4px solid;
    }

    .gap-card.winning {
        border-left-color: #28a745;
        background: linear-gradient(135deg, rgba(40, 167, 69, 0.05), rgba(40, 167, 69, 0.02));
    }

    .gap-card.losing {
        border-left-color: #dc3545;
        background: linear-gradient(135deg, rgba(220, 53, 69, 0.05), rgba(220, 53, 69, 0.02));
    }

    .gap-card.neutral {
        border-left-color: #ffc107;
        background: linear-gradient(135deg, rgba(255, 193, 7, 0.05), rgba(255, 193, 7, 0.02));
    }

    .gap-metric-name {
        font-size: 0.875rem;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 0.5rem;
    }

    .gap-values {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
    }

    .gap-your-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: #333;
    }

    .gap-best-value {
        font-size: 1.125rem;
        color: #6c757d;
    }

    .gap-opportunity {
        font-size: 0.875rem;
        color: #6c757d;
        font-style: italic;
    }

    .gap-status-badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
        margin-top: 0.5rem;
    }

    .gap-status-badge.winning {
        background: #28a745;
        color: white;
    }

    .gap-status-badge.losing {
        background: #dc3545;
        color: white;
    }

    .gap-status-badge.neutral {
        background: #ffc107;
        color: #333;
    }

    /* Heatmap Visualization */
    #heatmap-visualization {
        overflow-x: auto;
    }

    .heatmap-grid {
        display: grid;
        gap: 2px;
        background: #e9ecef;
        border-radius: 8px;
        padding: 2px;
        min-width: 600px;
    }

    .heatmap-row {
        display: grid;
        gap: 2px;
    }

    .heatmap-cell {
        background: white;
        padding: 1rem;
        text-align: center;
        font-weight: 500;
        transition: transform 0.2s;
    }

    .heatmap-cell:hover {
        transform: scale(1.02);
        z-index: 1;
    }

    .heatmap-cell.header {
        background: linear-gradient(135deg, #9926F3, #1DD8FC);
        color: white;
        font-weight: 600;
        font-size: 0.875rem;
    }

    .heatmap-cell.metric-name {
        background: #f8f9fa;
        text-align: left;
        font-weight: 600;
        color: #333;
    }

    .heatmap-cell.client-column {
        background: linear-gradient(135deg, rgba(153, 38, 243, 0.1), rgba(29, 216, 252, 0.1));
        border: 2px solid #9926F3;
        font-weight: 700;
    }

    /* Heatmap Color Coding */
    .heatmap-cell.excellent {
        background: linear-gradient(135deg, rgba(40, 167, 69, 0.2), rgba(40, 167, 69, 0.05));
        color: #155724;
    }

    .heatmap-cell.good {
        background: linear-gradient(135deg, rgba(23, 162, 184, 0.2), rgba(23, 162, 184, 0.05));
        color: #0c5460;
    }

    .heatmap-cell.warning {
        background: linear-gradient(135deg, rgba(255, 193, 7, 0.2), rgba(255, 193, 7, 0.05));
        color: #856404;
    }

    .heatmap-cell.danger {
        background: linear-gradient(135deg, rgba(220, 53, 69, 0.2), rgba(220, 53, 69, 0.05));
        color: #721c24;
    }

    .heatmap-cell.error {
        background: #f8f9fa;
        color: #dc3545;
        font-size: 0.75rem;
    }

    .metric-value {
        font-size: 1.25rem;
        font-weight: 700;
        display: block;
    }

    .metric-label {
        font-size: 0.75rem;
        color: #6c757d;
        margin-top: 0.25rem;
        display: block;
    }

    /* Comparison Table */
    .comparison-table {
        width: 100%;
        border-collapse: collapse;
        border-radius: 8px;
        overflow: hidden;
    }

    .comparison-table thead {
        background: linear-gradient(135deg, #9926F3, #1DD8FC);
        color: white;
    }

    .comparison-table th {
        padding: 1rem;
        text-align: left;
        font-weight: 600;
        font-size: 0.875rem;
    }

    .comparison-table th.client-column {
        background: rgba(255, 255, 255, 0.2);
    }

    .comparison-table td {
        padding: 0.875rem 1rem;
        border-bottom: 1px solid #e9ecef;
    }

    .comparison-table tbody tr:hover {
        background: #f8f9fa;
    }

    .comparison-table .metric-name-cell {
        font-weight: 600;
        color: #333;
    }

    .comparison-table .value-excellent {
        color: #28a745;
        font-weight: 600;
    }

    .comparison-table .value-good {
        color: #17a2b8;
        font-weight: 600;
    }

    .comparison-table .value-warning {
        color: #ffc107;
        font-weight: 600;
    }

    .comparison-table .value-danger {
        color: #dc3545;
        font-weight: 600;
    }

    .comparison-table .client-value {
        background: rgba(153, 38, 243, 0.05);
        font-weight: 700;
    }

    .table-responsive {
        overflow-x: auto;
        border-radius: 8px;
    }


    .empty-state {
        text-align: center;
        padding: 3rem;
        color: #6c757d;
    }

    .empty-state i {
        font-size: 4rem;
        opacity: 0.3;
        display: block;
        margin-bottom: 1rem;
    }

    .empty-state p {
        font-size: 1rem;
        margin: 0;
    }

    .data-table {
        width: 100%;
        border-collapse: collapse;
    }

    .data-table thead {
        background: linear-gradient(135deg, #9926F3, #1DD8FC);
        color: white;
    }

    .data-table th {
        padding: 1rem;
        text-align: left;
        font-weight: 600;
        font-size: 0.875rem;
    }

    .data-table td {
        padding: 0.875rem 1rem;
        border-bottom: 1px solid #e9ecef;
    }

    .data-table tbody tr:hover {
        background: #f8f9fa;
    }

    .table-responsive {
        overflow-x: auto;
        border-radius: 8px;
        max-height: 400px;
        overflow-y: auto;
    }



    @keyframes spin {
        from {
            transform: rotate(0deg);
        }

        to {
            transform: rotate(360deg);
        }
    }

    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }

        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    @keyframes slideOut {
        from {
            transform: translateX(0);
            opacity: 1;
        }

        to {
            transform: translateX(100%);
            opacity: 0;
        }
    }
</style>


{% endblock %}

{% block content %}
<div class="seo-container">
    <div class="header-hero">
        <div>
            <h1><i class="ti ti-search"></i> Smart SEO Toolkit</h1>
            <p>Enhance and automate your SEO with AI-powered tools</p>
        </div>
    </div>

    <!-- Tabs -->
    <div class="seo-tabs">
        <button class="seo-tab active" onclick="switchTab('projects')"><i class="ti ti-folder"></i> Projects</button>
        <button class="seo-tab" onclick="switchTab('audit')"><i class="ti ti-checklist"></i> SEO Audit</button>
        <button class="seo-tab" onclick="switchTab('competitor')"><i class="ti ti-chart-dots-3"></i> Competitor
            Analysis</button>
        <button class="seo-tab" onclick="switchTab('keywords')"><i class="ti ti-chart-line"></i> SERP Tracking</button>
        <button class="seo-tab" onclick="switchTab('backlinks')"><i class="ti ti-link"></i> Backlinks</button>
        <button class="seo-tab" onclick="switchTab('reports')"><i class="ti ti-chart-bar"></i> Reports</button>

        <button class="seo-tab" onclick="switchTab('optimization')"><i class="ti ti-wand"></i> Content
            Optimization</button>
        <button class="seo-tab" onclick="switchTab('voice')"><i class="ti ti-microphone"></i> Voice Search</button>

    </div>

    <!-- Projects Tab -->
    <div id="projects-tab" class="seo-tab-content active">
        <div class="seo-card">
            <div class="seo-card-header">
                <h3 class="seo-card-title"><i class="ti ti-folder"></i> SEO Projects</h3>
                <button class="btn-primary" onclick="openCreateProjectModal()"><i class="ti ti-plus"></i> New
                    Project</button>
            </div>
            <div id="projects-list"></div>
        </div>
    </div>

    <!-- SEO Audit Tab -->
    <div id="audit-tab" class="seo-tab-content">
        <div class="seo-card">
            <h3 class="seo-card-title"><i class="ti ti-checklist"></i> Run Comprehensive SEO Audit</h3>
            <p style="color: #6c757d; margin-bottom: 1rem;">Analyzes Domain Authority, Backlinks, Site Performance, and
                Usability metrics using Moz API and PageSpeed Insights.</p>
            <div class="form-group">
                <label class="form-label">Select Project</label>
                <select id="audit-project" class="form-control">
                    <option value="">Select a project...</option>
                </select>
            </div>
            <button class="btn-primary" onclick="runComprehensiveAudit()"><i class="ti ti-checklist"></i> Run Full
                Audit</button>
        </div>

        <div id="audit-results" style="display: none;">
            <!-- Scores Overview -->
            <div class="seo-card">
                <h3 class="seo-card-title"><i class="ti ti-chart-pie"></i> SEO Scores Overview</h3>
                <div class="scores-grid" id="scores-grid"></div>
            </div>

            <!-- Core Web Vitals -->
            <div class="seo-card">
                <h3 class="seo-card-title"><i class="ti ti-gauge"></i> Core Web Vitals</h3>
                <div class="cwv-grid" id="cwv-grid"></div>
            </div>

            <div class="two-col">
                <!-- Backlinks Overview -->
                <div class="seo-card">
                    <h3 class="seo-card-title"><i class="ti ti-link"></i> Backlinks Overview</h3>
                    <div id="backlinks-overview"></div>
                </div>

                <!-- Usability Metrics -->
                <div class="seo-card">
                    <h3 class="seo-card-title"><i class="ti ti-device-desktop"></i> Usability Metrics</h3>
                    <div id="usability-metrics"></div>
                </div>
            </div>

            <!-- Technical Issues -->
            <div class="seo-card">
                <h3 class="seo-card-title"><i class="ti ti-alert-triangle"></i> Technical Issues</h3>
                <ul class="issues-list" id="issues-list"></ul>
            </div>

            <!-- Recommendations -->
            <div class="seo-card">
                <h3 class="seo-card-title"><i class="ti ti-bulb"></i> Recommendations</h3>
                <div id="recommendations-list"></div>
            </div>
        </div>

        <div class="seo-card">
            <h3 class="seo-card-title"><i class="ti ti-history"></i> Audit History</h3>
            <div id="audit-history"></div>
        </div>
    </div>

    <!-- Keyword Tracking Tab -->
    <div id="keywords-tab" class="seo-tab-content">
        <div class="seo-card">
            <h3 class="seo-card-title"><i class="ti ti-chart-line"></i> Track Keywords</h3>
            <p style="color: #6c757d; margin-bottom: 1rem;">Track keyword positions with search volume, difficulty, and
                position changes.</p>
            <div class="form-group">
                <label class="form-label">Select Project</label>
                <select id="keyword-project" class="form-control" onchange="loadKeywordRankings()">
                    <option value="">Select a project...</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Keyword</label>
                <input type="text" id="keyword-input" class="form-control" placeholder="Enter keyword to track">
            </div>
            <button class="btn-primary" onclick="trackKeyword()"><i class="ti ti-chart-line"></i> Track Keyword</button>
        </div>

        <div class="seo-card">
            <h3 class="seo-card-title"><i class="ti ti-list"></i> Keyword Rankings</h3>
            <div id="keyword-rankings"></div>
        </div>
    </div>


    <!-- Competitor Analysis Tab -->
    <div id="competitor-tab" class="seo-tab-content">
        <div class="seo-card">
            <h3 class="seo-card-title"><i class="ti ti-chart-dots-3"></i> Competitor Comparison Heatmap</h3>
            <p style="color: #6c757d; margin-bottom: 1.5rem;">
                Compare your website's SEO metrics against competitors to identify gaps and opportunities.
            </p>

            <div class="form-group">
                <label class="form-label">Select SEO Project</label>
                <select id="heatmap-project" class="form-control" onchange="clearHeatmapResults()">
                    <option value="">Select a project...</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Competitor URLs (Max 5)</label>
                <div id="competitor-inputs">
                    <div class="competitor-input-group">
                        <input type="url" class="form-control competitor-url" placeholder="https://competitor1.com">
                        <button class="btn-icon-remove" onclick="removeCompetitorInput(this)" style="display: none;">
                            <i class="ti ti-x"></i>
                        </button>
                    </div>
                </div>
                <button class="btn-secondary" onclick="addCompetitorInput()" id="add-competitor-btn"
                    style="margin-top: 0.5rem;">
                    <i class="ti ti-plus"></i> Add Competitor
                </button>
            </div>

            <button class="btn-primary" onclick="generateHeatmap()">
                <i class="ti ti-chart-dots-3"></i> Generate Comparison Heatmap
            </button>
        </div>

        <!-- Heatmap Results -->
        <div id="heatmap-results" style="display: none;">
            <!-- Gap Analysis Summary -->
            <div class="seo-card">
                <h3 class="seo-card-title"><i class="ti ti-bulb"></i> Gap Analysis & Opportunities</h3>
                <div id="gaps-summary"></div>
            </div>

            <!-- Visual Heatmap -->
            <div class="seo-card">
                <h3 class="seo-card-title"><i class="ti ti-chart-dots-3"></i> Visual Comparison Heatmap</h3>
                <p style="color: #6c757d; margin-bottom: 1rem;">
                    Green = Leading | Yellow = Moderate | Red = Needs Improvement
                </p>
                <div id="heatmap-visualization"></div>
            </div>

            <!-- Detailed Metrics Table -->
            <div class="seo-card">
                <h3 class="seo-card-title"><i class="ti ti-table"></i> Detailed Metrics Comparison</h3>
                <div class="table-responsive">
                    <table class="comparison-table" id="metrics-table">
                        <thead>
                            <tr>
                                <th>Metric</th>
                                <th class="client-column">Your Site</th>
                            </tr>
                        </thead>
                        <tbody id="metrics-table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>


    <!-- Backlinks Tab -->
    <div id="backlinks-tab" class="seo-tab-content">
        <!-- Backlink Target Suggestions -->
        <div class="seo-card">
            <h3 class="seo-card-title"><i class="ti ti-target"></i> Backlink Strategist - Find Targets</h3>
            <p style="color: #6c757d; margin-bottom: 1rem;">AI-powered backlink opportunity suggestions with Domain
                Authority scoring.</p>
            <div class="two-col">
                <div class="form-group">
                    <label class="form-label">Select Project</label>
                    <select id="backlink-suggest-project" class="form-control">
                        <option value="">Select a project...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Your Niche</label>
                    <input type="text" id="backlink-niche" class="form-control"
                        placeholder="e.g., Digital Marketing, SaaS, Healthcare">
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Minimum Domain Authority</label>
                <select id="min-da" class="form-control">
                    <option value="20">20+ (All)</option>
                    <option value="30" selected>30+ (Moderate)</option>
                    <option value="40">40+ (Good)</option>
                    <option value="50">50+ (Strong)</option>
                    <option value="60">60+ (High Authority)</option>
                </select>
            </div>
            <button class="btn-primary" onclick="suggestBacklinkTargets()"><i class="ti ti-target"></i> Find Backlink
                Targets</button>
        </div>

        <div id="backlink-targets-results" style="display: none;">
            <div class="seo-card">
                <h3 class="seo-card-title"><i class="ti ti-list-check"></i> Suggested Targets</h3>
                <div class="targets-grid" id="targets-grid"></div>
            </div>
        </div>

        <!-- Outreach Email Generator -->
        <div class="seo-card">
            <h3 class="seo-card-title"><i class="ti ti-mail"></i> Generate Outreach Email</h3>
            <div class="form-group">
                <label class="form-label">Select Project</label>
                <select id="backlink-project" class="form-control">
                    <option value="">Select a project...</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Target Website URL</label>
                <input type="url" id="target-url" class="form-control" placeholder="https://example.com">
            </div>
            <div class="form-group">
                <label class="form-label">Desired Anchor Text</label>
                <input type="text" id="anchor-text" class="form-control" placeholder="e.g., SEO best practices">
            </div>
            <button class="btn-primary" onclick="generateOutreachEmail()"><i class="ti ti-mail"></i> Generate
                Email</button>
        </div>

        <div id="outreach-results" style="display: none;">
            <div class="seo-card">
                <h3 class="seo-card-title"><i class="ti ti-mail-forward"></i> Outreach Email</h3>
                <div id="outreach-email-content"></div>
            </div>
        </div>

        <div class="seo-card">
            <h3 class="seo-card-title"><i class="ti ti-history"></i> Backlink History</h3>
            <div id="backlink-history"></div>
        </div>
    </div>

    <!-- Content Optimization Tab -->
    <div id="optimization-tab" class="seo-tab-content">
        <div class="seo-card">
            <h3 class="seo-card-title"><i class="ti ti-wand"></i> AI-Powered Content Optimization</h3>
            <div class="form-group">
                <label class="form-label">Target Keyword</label>
                <input type="text" id="opt-keyword" class="form-control" placeholder="Enter your target keyword">
            </div>
            <div class="form-group">
                <label class="form-label">Content Type</label>
                <select id="opt-content-type" class="form-control">
                    <option value="blog">Blog Post</option>
                    <option value="product">Product Description</option>
                    <option value="landing">Landing Page</option>
                    <option value="article">Article</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Content</label>
                <textarea id="opt-content" class="form-control form-control-textarea"
                    placeholder="Paste your content here..."></textarea>
            </div>
            <button class="btn-primary" onclick="optimizeContent()"><i class="ti ti-wand"></i> Analyze &
                Optimize</button>
        </div>
        <div id="optimization-results" style="display: none;">
            <div class="seo-card">
                <h3 class="seo-card-title"><i class="ti ti-report-analytics"></i> Optimization Results</h3>
                <div id="optimization-data"></div>
            </div>
        </div>
    </div>

    <!-- Voice Search Tab -->
    <div id="voice-tab" class="seo-tab-content">
        <div class="seo-card">
            <h3 class="seo-card-title"><i class="ti ti-microphone"></i> Voice Search Optimization</h3>
            <p style="color: #6c757d; margin-bottom: 1rem;">Optimize your content for voice search and featured
                snippets.</p>
            <div class="form-group">
                <label class="form-label">Content to Analyze</label>
                <textarea id="voice-content" class="form-control form-control-textarea"
                    placeholder="Paste your content here..."></textarea>
            </div>
            <button class="btn-primary" onclick="optimizeVoiceSearch()"><i class="ti ti-microphone"></i> Analyze for
                Voice Search</button>
        </div>
        <div id="voice-results" style="display: none;">
            <div class="seo-card">
                <h3 class="seo-card-title"><i class="ti ti-report"></i> Voice Search Analysis</h3>
                <div id="voice-data"></div>
            </div>
        </div>
    </div>
</div>

<!-- Create Project Modal -->
<div class="modal-overlay" id="create-project-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Create SEO Project</h3>
            <button class="modal-close" onclick="closeCreateProjectModal()">&times;</button>
        </div>
        <div class="form-group">
            <label class="form-label">Website URL</label>
            <input type="url" id="project-url" class="form-control" placeholder="https://example.com">
        </div>
        <div class="form-group">
            <label class="form-label">Target Keywords (comma separated)</label>
            <input type="text" id="project-keywords" class="form-control" placeholder="seo, digital marketing, content">
        </div>
        <button class="btn-primary" onclick="createProject()" style="width: 100%;"><i class="ti ti-plus"></i> Create
            Project</button>
    </div>
</div>


<div id="reports-tab" class="seo-tab-content">
    <div class="seo-card">
        <div class="seo-card-header">
            <h3 class="seo-card-title"><i class="ti ti-chart-bar"></i> Monthly SEO Performance Report</h3>
            <button class="btn-primary" onclick="syncPerformanceData()">
                <i class="ti ti-refresh"></i> Sync Data
            </button>
        </div>

        <div class="form-group">
            <label class="form-label">Select Project</label>
            <select id="reports-project" class="form-control" onchange="loadMonthlyReport()">
                <option value="">Select a project...</option>
            </select>
        </div>

        <div class="form-group">
            <label class="form-label">Time Range</label>
            <select id="reports-months" class="form-control" onchange="loadMonthlyReport()">
                <option value="1">Last Month</option>
                <option value="3" selected>Last 3 Months</option>
                <option value="6">Last 6 Months</option>
                <option value="12">Last 12 Months</option>
            </select>
        </div>
    </div>

    <!-- Performance Summary Cards -->
    <div id="reports-summary" style="display: none;">
        <div class="scores-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
            <div class="score-card">
                <div class="score-card-label">Total Traffic</div>
                <div class="score-card-value" id="report-total-traffic">0</div>
                <div class="score-card-sublabel">Organic Clicks</div>
            </div>
            <div class="score-card">
                <div class="score-card-label">Total Impressions</div>
                <div class="score-card-value" id="report-total-impressions">0</div>
                <div class="score-card-sublabel">Search Appearances</div>
            </div>
            <div class="score-card">
                <div class="score-card-label">Total Clicks</div>
                <div class="score-card-value" id="report-total-clicks">0</div>
                <div class="score-card-sublabel">User Actions</div>
            </div>
            <div class="score-card">
                <div class="score-card-label">Average CTR</div>
                <div class="score-card-value" id="report-avg-ctr">0%</div>
                <div class="score-card-sublabel">Click-Through Rate</div>
            </div>
            <div class="score-card">
                <div class="score-card-label">Average Position</div>
                <div class="score-card-value" id="report-avg-position">0</div>
                <div class="score-card-sublabel">Search Ranking</div>
            </div>
        </div>

        <!-- Monthly Graphs -->
        <div class="seo-card" style="margin-top: 1.5rem;">
            <h3 class="seo-card-title"><i class="ti ti-chart-line"></i> Monthly Traffic Trend</h3>
            <canvas id="traffic-chart" style="max-height: 350px;"></canvas>
        </div>

        <div
            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 1.5rem; margin-top: 1.5rem;">
            <div class="seo-card">
                <h3 class="seo-card-title"><i class="ti ti-click"></i> Monthly Clicks</h3>
                <canvas id="clicks-chart" style="max-height: 300px;"></canvas>
            </div>

            <div class="seo-card">
                <h3 class="seo-card-title"><i class="ti ti-eye"></i> Monthly Impressions</h3>
                <canvas id="impressions-chart" style="max-height: 300px;"></canvas>
            </div>
        </div>

        <!-- Daily Data Table -->
        <div class="seo-card" style="margin-top: 1.5rem;">
            <div class="seo-card-header">
                <h3 class="seo-card-title"><i class="ti ti-table"></i> Daily Performance Data</h3>
                <button class="btn-secondary" onclick="exportReport()">
                    <i class="ti ti-download"></i> Export
                </button>
            </div>
            <div class="table-responsive">
                <table class="data-table" id="daily-data-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Traffic (Clicks)</th>
                            <th>Impressions</th>
                            <th>CTR</th>
                            <th>Avg Position</th>
                        </tr>
                    </thead>
                    <tbody id="daily-data-body">
                        <tr>
                            <td colspan="5" style="text-align: center; color: #6c757d;">No data available</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="reports-empty" class="empty-state">
        <i class="ti ti-chart-bar-off"></i>
        <p>Select a project and sync data to view monthly reports</p>
    </div>
</div>


{% endblock %}

{% block extra_js %}

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
    const API_BASE = '/api/v1/seo';
    const token = localStorage.getItem('access_token');

    // Tab Switching
    function switchTab(tabName) {
        document.querySelectorAll('.seo-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.seo-tab-content').forEach(c => c.classList.remove('active'));

        const tabIndex = getTabIndex(tabName);
        document.querySelector(`.seo-tab:nth-child(${tabIndex})`).classList.add('active');
        document.getElementById(`${tabName}-tab`).classList.add('active');

        if (tabName === 'keywords') loadKeywordRankings();
        if (tabName === 'backlinks') loadBacklinkHistory();
        if (tabName === 'reports') loadMonthlyReport();  // ADD THIS LINE
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        loadProjects();
    });

    // Projects
    async function loadProjects() {
        try {
            const response = await fetch(`${API_BASE}/projects/list`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const data = await response.json();

            if (data.success) {
                displayProjects(data.projects);
                populateProjectSelects(data.projects);
            }
        } catch (error) {
            console.error('Error loading projects:', error);
        }
    }

    function displayProjects(projects) {
        const container = document.getElementById('projects-list');
        if (!projects || projects.length === 0) {
            container.innerHTML = `<div class="empty-state"><i class="ti ti-folder-off"></i><p>No SEO projects yet. Create your first project!</p></div>`;
            return;
        }

        container.innerHTML = `
        <table class="data-table">
            <thead><tr><th>Website</th><th>Domain Authority</th><th>Keywords</th><th>Status</th><th>Created</th></tr></thead>
            <tbody>
                ${projects.map(p => `
                    <tr>
                        <td><a href="${p.website_url}" target="_blank">${p.website_url}</a></td>
                        <td><span class="badge ${p.current_domain_authority >= 50 ? 'badge-success' : p.current_domain_authority >= 30 ? 'badge-warning' : 'badge-danger'}">${p.current_domain_authority || 0}</span></td>
                        <td>${(p.target_keywords || []).slice(0, 3).join(', ') || 'None'}</td>
                        <td><span class="badge badge-${p.status === 'active' ? 'success' : 'secondary'}">${p.status}</span></td>
                        <td>${new Date(p.created_at).toLocaleDateString()}</td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;
    }

    function populateProjectSelects(projects) {
        const selects = [
            'audit-project',
            'keyword-project',
            'backlink-project',
            'backlink-suggest-project',
            'heatmap-project',
            'reports-project'  // THIS LINE WAS MISSING!
        ];

        selects.forEach(selectId => {
            const select = document.getElementById(selectId);
            if (select) {
                select.innerHTML = '<option value="">Select a project...</option>';
                projects.forEach(p => {
                    select.innerHTML += `<option value="${p.seo_project_id}">${p.website_url}</option>`;
                });
            }
        });
    }

    function openCreateProjectModal() { document.getElementById('create-project-modal').classList.add('active'); }
    function closeCreateProjectModal() { document.getElementById('create-project-modal').classList.remove('active'); }

    async function createProject() {
        const url = document.getElementById('project-url').value;
        const keywords = document.getElementById('project-keywords').value.split(',').map(k => k.trim()).filter(k => k);

        if (!url) { alert('Please enter a website URL'); return; }

        try {
            const response = await fetch(`${API_BASE}/projects/create`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify({ website_url: url, target_keywords: keywords })
            });
            const data = await response.json();

            if (data.success) {
                alert(`Project created!\nDomain Authority: ${data.domain_authority}`);
                closeCreateProjectModal();
                loadProjects();
                document.getElementById('project-url').value = '';
                document.getElementById('project-keywords').value = '';
            } else {
                alert('Failed: ' + (data.detail || 'Unknown error'));
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Failed to create project');
        }
    }

    // Comprehensive SEO Audit
    async function runComprehensiveAudit() {
        const projectId = document.getElementById('audit-project').value;
        if (!projectId) { alert('Please select a project'); return; }

        const btn = event.target;
        btn.disabled = true;
        btn.innerHTML = '<i class="ti ti-loader"></i> Running Audit...<span class="loading-spinner"></span>';

        try {
            const response = await fetch(`${API_BASE}/audit/run`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify({ seo_project_id: parseInt(projectId) })
            });
            const data = await response.json();

            if (data.success) {
                displayAuditResults(data);
                document.getElementById('audit-results').style.display = 'block';
            } else {
                alert('Audit failed: ' + (data.detail || 'Unknown error'));
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Audit failed: ' + error.message);
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="ti ti-checklist"></i> Run Full Audit';
        }
    }

    function displayAuditResults(data) {
        const scores = data.scores;

        // Scores Grid
        document.getElementById('scores-grid').innerHTML = `
        ${createScoreCard('Overall Score', scores.overall_score, '/100')}
        ${createScoreCard('Domain Authority', scores.domain_authority, '/100')}
        ${createScoreCard('Page Authority', scores.page_authority, '/100')}
        ${createScoreCard('Spam Score', scores.spam_score, '%', true)}
        ${createScoreCard('Mobile Performance', scores.performance_mobile, '/100')}
        ${createScoreCard('Desktop Performance', scores.performance_desktop, '/100')}
        ${createScoreCard('SEO Score', scores.seo_score, '/100')}
        ${createScoreCard('Accessibility', scores.accessibility_score, '/100')}
    `;

        // Core Web Vitals
        const cwv = data.core_web_vitals || {};
        document.getElementById('cwv-grid').innerHTML = `
        <div class="cwv-item"><div class="cwv-label">LCP</div><div class="cwv-value ${cwv.largest_contentful_paint <= 2.5 ? 'excellent' : cwv.largest_contentful_paint <= 4 ? 'warning' : 'danger'}">${cwv.largest_contentful_paint || 'N/A'}</div><div class="cwv-unit">seconds</div></div>
        <div class="cwv-item"><div class="cwv-label">FCP</div><div class="cwv-value ${cwv.first_contentful_paint <= 1.8 ? 'excellent' : cwv.first_contentful_paint <= 3 ? 'warning' : 'danger'}">${cwv.first_contentful_paint || 'N/A'}</div><div class="cwv-unit">seconds</div></div>
        <div class="cwv-item"><div class="cwv-label">CLS</div><div class="cwv-value ${cwv.cumulative_layout_shift <= 0.1 ? 'excellent' : cwv.cumulative_layout_shift <= 0.25 ? 'warning' : 'danger'}">${cwv.cumulative_layout_shift || 'N/A'}</div><div class="cwv-unit">score</div></div>
        <div class="cwv-item"><div class="cwv-label">TBT</div><div class="cwv-value ${cwv.total_blocking_time <= 200 ? 'excellent' : cwv.total_blocking_time <= 600 ? 'warning' : 'danger'}">${cwv.total_blocking_time || 'N/A'}</div><div class="cwv-unit">ms</div></div>
        <div class="cwv-item"><div class="cwv-label">Speed Index</div><div class="cwv-value ${cwv.speed_index <= 3.4 ? 'excellent' : cwv.speed_index <= 5.8 ? 'warning' : 'danger'}">${cwv.speed_index || 'N/A'}</div><div class="cwv-unit">seconds</div></div>
    `;

        // Backlinks Overview
        const bl = data.backlinks || {};
        document.getElementById('backlinks-overview').innerHTML = `
        <div class="scores-grid">
            ${createScoreCard('Total Backlinks', bl.total_backlinks || 0, '')}
            ${createScoreCard('Referring Domains', bl.referring_domains || 0, '')}
        </div>
        ${bl.top_anchor_texts && bl.top_anchor_texts.length > 0 ? `
        <h4 style="margin: 1rem 0 0.5rem;">Top Anchor Texts</h4>
        <ul style="margin: 0; padding-left: 1.5rem;">
            ${bl.top_anchor_texts.slice(0, 5).map(a => `<li>${a.anchor_text || 'No anchor'} (${a.external_pages || 0} links)</li>`).join('')}
        </ul>` : ''}
    `;

        // Usability Metrics
        const usability = data.usability || {};
        document.getElementById('usability-metrics').innerHTML = `
        <div class="scores-grid">
            ${createScoreCard('Mobile Friendly', usability.mobile_friendly ? 'Yes' : 'No', '', false, usability.mobile_friendly)}
            ${createScoreCard('Accessibility Score', usability.accessibility_score || 0, '/100')}
            ${createScoreCard('Total Issues', usability.issues_count || 0, '')}
            ${createScoreCard('Critical Issues', usability.critical_issues || 0, '', true)}
        </div>
    `;

        // Technical Issues
        const issues = data.technical_issues || [];
        document.getElementById('issues-list').innerHTML = issues.length > 0
            ? issues.map(i => `
            <li class="issue-item ${i.severity}">
                <div class="issue-category">${i.category} <span class="badge badge-${i.severity === 'high' ? 'danger' : i.severity === 'medium' ? 'warning' : 'info'}">${i.severity}</span></div>
                <div class="issue-text">${i.issue}</div>
                <div class="issue-recommendation"><i class="ti ti-bulb"></i> ${i.recommendation}</div>
            </li>
        `).join('')
            : '<div class="empty-state"><i class="ti ti-check"></i><p>No critical issues found!</p></div>';

        // Recommendations
        const recs = data.recommendations || [];
        document.getElementById('recommendations-list').innerHTML = recs.length > 0
            ? recs.map(r => `
            <div class="issue-item ${r.priority}">
                <div class="issue-category">${r.category} <span class="badge badge-${r.priority === 'high' ? 'danger' : r.priority === 'medium' ? 'warning' : 'info'}">${r.priority}</span></div>
                <div class="issue-text"><strong>${r.action}</strong></div>
                <div class="issue-recommendation">${r.details}</div>
            </div>
        `).join('')
            : '<div class="empty-state"><i class="ti ti-check"></i><p>No recommendations</p></div>';
    }

    function createScoreCard(label, value, suffix = '', inverse = false, boolValue = null) {
        let colorClass = 'good';
        if (boolValue !== null) {
            colorClass = boolValue ? 'excellent' : 'danger';
        } else if (typeof value === 'number') {
            if (inverse) {
                colorClass = value <= 10 ? 'excellent' : value <= 30 ? 'good' : value <= 50 ? 'warning' : 'danger';
            } else {
                colorClass = value >= 80 ? 'excellent' : value >= 60 ? 'good' : value >= 40 ? 'warning' : 'danger';
            }
        }
        return `<div class="score-card"><div class="score-card-label">${label}</div><div class="score-card-value ${colorClass}">${value}${suffix}</div></div>`;
    }

    // Keyword Tracking
    async function trackKeyword() {
        const projectId = document.getElementById('keyword-project').value;
        const keyword = document.getElementById('keyword-input').value.trim();

        if (!projectId || !keyword) { alert('Please select a project and enter a keyword'); return; }

        const btn = event.target;
        btn.disabled = true;
        btn.innerHTML = '<i class="ti ti-loader"></i> Tracking...<span class="loading-spinner"></span>';

        try {
            const response = await fetch(`${API_BASE}/keywords/track`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify({ seo_project_id: parseInt(projectId), keyword: keyword })
            });
            const data = await response.json();

            if (data.success) {
                let message = `Keyword tracked successfully!\n\nKeyword: ${data.keyword}\nPosition: #${data.current_position}\nSearch Volume: ${data.search_volume.toLocaleString()}\nDifficulty: ${data.difficulty}/100`;
                if (data.position_change !== 0) {
                    message += `\nPosition Change: ${data.position_change > 0 ? '+' : ''}${data.position_change}`;
                }
                alert(message);
                document.getElementById('keyword-input').value = '';
                loadKeywordRankings();
            } else {
                alert('Failed: ' + (data.detail || 'Unknown error'));
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Failed to track keyword');
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="ti ti-chart-line"></i> Track Keyword';
        }
    }

    async function loadKeywordRankings() {
        const projectId = document.getElementById('keyword-project').value;
        const container = document.getElementById('keyword-rankings');

        if (!projectId) {
            container.innerHTML = '<div class="empty-state"><i class="ti ti-chart-line"></i><p>Select a project to view keyword rankings</p></div>';
            return;
        }

        container.innerHTML = '<div class="empty-state"><i class="ti ti-loader"></i><p>Loading...</p></div>';

        try {
            const response = await fetch(`${API_BASE}/keywords/history/${projectId}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const data = await response.json();

            if (data.success && data.keywords && data.keywords.length > 0) {
                container.innerHTML = `
                <table class="data-table">
                    <thead><tr><th>Keyword</th><th>Position</th><th>Change</th><th>Volume</th><th>Trend</th><th>Date</th></tr></thead>
                    <tbody>
                        ${data.keywords.map(kw => {
                    const posClass = kw.current_position <= 10 ? 'top-10' : kw.current_position <= 50 ? 'top-50' : 'beyond';
                    const trendIcon = kw.trend === 'up' ? '<i class="ti ti-trending-up trend-up"></i>' : kw.trend === 'down' ? '<i class="ti ti-trending-down trend-down"></i>' : '<i class="ti ti-minus trend-stable"></i>';
                    const changeClass = kw.position_change > 0 ? 'trend-up' : kw.position_change < 0 ? 'trend-down' : 'trend-stable';
                    return `
                                <tr>
                                    <td><strong>${kw.keyword}</strong></td>
                                    <td><span class="position-badge ${posClass}">#${kw.current_position}</span></td>
                                    <td class="${changeClass}">${kw.position_change > 0 ? '+' : ''}${kw.position_change || 0}</td>
                                    <td>${kw.search_volume ? kw.search_volume.toLocaleString() : 'N/A'}</td>
                                    <td>${trendIcon}</td>
                                    <td>${new Date(kw.tracked_date).toLocaleDateString()}</td>
                                </tr>
                            `;
                }).join('')}
                    </tbody>
                </table>
            `;
            } else {
                container.innerHTML = '<div class="empty-state"><i class="ti ti-chart-line"></i><p>No keywords tracked yet</p></div>';
            }
        } catch (error) {
            console.error('Error:', error);
            container.innerHTML = '<div class="empty-state"><i class="ti ti-alert-circle" style="color: #dc3545;"></i><p>Failed to load keywords</p></div>';
        }
    }

    // Backlink Strategist
    async function suggestBacklinkTargets() {
        const projectId = document.getElementById('backlink-suggest-project').value;
        const niche = document.getElementById('backlink-niche').value.trim();
        const minDa = document.getElementById('min-da').value;

        if (!projectId || !niche) { alert('Please select a project and enter your niche'); return; }

        const btn = event.target;
        btn.disabled = true;
        btn.innerHTML = '<i class="ti ti-loader"></i> Finding Targets...<span class="loading-spinner"></span>';

        try {
            const response = await fetch(`${API_BASE}/backlinks/suggest-targets`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify({ seo_project_id: parseInt(projectId), niche: niche, min_da: parseInt(minDa) })
            });
            const data = await response.json();

            if (data.success) {
                displayBacklinkTargets(data);
                document.getElementById('backlink-targets-results').style.display = 'block';
            } else {
                alert('Failed: ' + (data.detail || 'Unknown error'));
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Failed to find targets');
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="ti ti-target"></i> Find Backlink Targets';
        }
    }

    function displayBacklinkTargets(data) {
        const container = document.getElementById('targets-grid');
        container.innerHTML = data.targets.map(t => `
        <div class="target-card">
            <div class="target-header">
                <div class="target-type"><i class="ti ti-${t.target_type === 'Guest Post' ? 'edit' : t.target_type === 'Resource Page' ? 'bookmark' : 'link'}"></i> ${t.target_type}</div>
                <div class="target-da ${t.estimated_da >= 50 ? 'high' : t.estimated_da >= 30 ? 'medium' : 'low'}">DA ${t.estimated_da}</div>
            </div>
            <div class="target-description">${t.description}</div>
            <div class="target-strategy"><strong>Strategy:</strong> ${t.outreach_strategy}</div>
            <div style="margin-top: 0.75rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                <span class="badge badge-${t.difficulty === 'easy' ? 'success' : t.difficulty === 'medium' ? 'warning' : 'danger'}">${t.difficulty}</span>
                <span class="badge badge-info">Relevance: ${t.relevance_score}%</span>
            </div>
        </div>
    `).join('');
    }

    async function generateOutreachEmail() {
        const projectId = document.getElementById('backlink-project').value;
        const targetUrl = document.getElementById('target-url').value.trim();
        const anchorText = document.getElementById('anchor-text').value.trim();

        if (!projectId || !targetUrl || !anchorText) { alert('Please fill all fields'); return; }

        const btn = event.target;
        btn.disabled = true;
        btn.innerHTML = '<i class="ti ti-loader"></i> Generating...<span class="loading-spinner"></span>';

        try {
            const response = await fetch(`${API_BASE}/backlinks/outreach`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify({ seo_project_id: parseInt(projectId), target_url: targetUrl, anchor_text: anchorText })
            });
            const data = await response.json();

            if (data.success) {
                displayOutreachEmail(data);
                document.getElementById('outreach-results').style.display = 'block';
                loadBacklinkHistory();
            } else {
                alert('Failed: ' + (data.detail || 'Unknown error'));
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Failed to generate email');
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="ti ti-mail"></i> Generate Email';
        }
    }

    function displayOutreachEmail(data) {
        const email = data.outreach_email;
        document.getElementById('outreach-email-content').innerHTML = `
        <div style="margin-bottom: 1rem;">
            <span class="badge badge-info">Target DA: ${data.target_da}</span>
            <span class="badge badge-secondary">${data.target_url}</span>
        </div>
        <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
            <strong>Subject:</strong> ${email.subject}
        </div>
        <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; white-space: pre-wrap; margin-bottom: 1rem;">
            ${email.body}
        </div>
        <h4>Follow-up Email</h4>
        <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; white-space: pre-wrap;">
            ${email.follow_up}
        </div>
        <button class="btn-secondary" style="margin-top: 1rem;" onclick="copyToClipboard('${email.body.replace(/'/g, "\\'")}')"><i class="ti ti-copy"></i> Copy Email</button>
    `;
    }

    async function loadBacklinkHistory() {
        const projectId = document.getElementById('backlink-project').value;
        const container = document.getElementById('backlink-history');

        if (!projectId) {
            container.innerHTML = '<div class="empty-state"><i class="ti ti-link"></i><p>Select a project to view backlink history</p></div>';
            return;
        }

        try {
            const response = await fetch(`${API_BASE}/backlinks/list/${projectId}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const data = await response.json();

            if (data.success && data.backlinks && data.backlinks.length > 0) {
                container.innerHTML = `
                <table class="data-table">
                    <thead><tr><th>Target URL</th><th>Anchor Text</th><th>Status</th><th>Created</th></tr></thead>
                    <tbody>
                        ${data.backlinks.map(bl => `
                            <tr>
                                <td><a href="${bl.source_url}" target="_blank">${bl.source_url.substring(0, 40)}...</a></td>
                                <td>${bl.anchor_text}</td>
                                <td><span class="badge badge-${bl.status === 'active' ? 'success' : bl.status === 'pending' ? 'warning' : 'secondary'}">${bl.status}</span></td>
                                <td>${new Date(bl.created_at).toLocaleDateString()}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            } else {
                container.innerHTML = '<div class="empty-state"><i class="ti ti-link"></i><p>No backlinks yet</p></div>';
            }
        } catch (error) {
            console.error('Error:', error);
        }
    }

    // Content Optimization
    async function optimizeContent() {
        const keyword = document.getElementById('opt-keyword').value.trim();
        const content = document.getElementById('opt-content').value.trim();
        const contentType = document.getElementById('opt-content-type').value;

        if (!keyword || !content) { alert('Please enter keyword and content'); return; }

        const btn = event.target;
        btn.disabled = true;
        btn.innerHTML = '<i class="ti ti-loader"></i> Analyzing...<span class="loading-spinner"></span>';

        try {
            const response = await fetch(`${API_BASE}/optimize-content`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify({ content: content, target_keyword: keyword, content_type: contentType })
            });
            const data = await response.json();

            if (data.success) {
                displayOptimizationResults(data.optimization);
                document.getElementById('optimization-results').style.display = 'block';
            } else {
                alert('Failed: ' + (data.detail || 'Unknown error'));
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Failed to optimize content');
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="ti ti-wand"></i> Analyze & Optimize';
        }
    }

    function displayOptimizationResults(opt) {
        const scoreClass = opt.overall_score >= 80 ? 'excellent' : opt.overall_score >= 60 ? 'good' : opt.overall_score >= 40 ? 'warning' : 'danger';
        document.getElementById('optimization-data').innerHTML = `
        <div class="scores-grid">
            ${createScoreCard('Overall Score', opt.overall_score, '/100')}
            ${createScoreCard('Readability', opt.readability_score || 0, '/100')}
            ${createScoreCard('Word Count', opt.word_count || 0, '')}
            ${createScoreCard('Keyword Density', opt.keyword_density ? opt.keyword_density.toFixed(2) : 0, '%')}
        </div>
        ${opt.meta_description_suggestion ? `<div style="margin: 1rem 0; padding: 1rem; background: #e8f5e9; border-radius: 8px;"><strong>Suggested Meta Description:</strong><br>${opt.meta_description_suggestion}</div>` : ''}
        ${opt.keyword_variations && opt.keyword_variations.length > 0 ? `<div style="margin: 1rem 0;"><strong>Related Keywords:</strong><br>${opt.keyword_variations.map(k => `<span class="badge badge-info" style="margin: 0.25rem;">${k}</span>`).join('')}</div>` : ''}
        ${opt.recommendations && opt.recommendations.length > 0 ? `<h4 style="margin: 1rem 0 0.5rem;">Recommendations</h4><ul>${opt.recommendations.map(r => `<li>${r}</li>`).join('')}</ul>` : ''}
    `;
    }

    // Voice Search
    async function optimizeVoiceSearch() {
        const content = document.getElementById('voice-content').value.trim();
        if (!content) { alert('Please enter content'); return; }

        const btn = event.target;
        btn.disabled = true;
        btn.innerHTML = '<i class="ti ti-loader"></i> Analyzing...<span class="loading-spinner"></span>';

        try {
            const response = await fetch(`${API_BASE}/voice-search/optimize`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify({ content: content })
            });
            const data = await response.json();

            if (data.success) {
                displayVoiceResults(data.optimization);
                document.getElementById('voice-results').style.display = 'block';
            } else {
                alert('Failed: ' + (data.detail || 'Unknown error'));
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Failed to analyze');
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="ti ti-microphone"></i> Analyze for Voice Search';
        }
    }

    function displayVoiceResults(opt) {
        document.getElementById('voice-data').innerHTML = `
        <div class="scores-grid">
            ${createScoreCard('Voice Search Score', opt.voice_search_score || 0, '/100')}
            ${createScoreCard('Featured Snippet Potential', opt.featured_snippet_potential || 0, '/100')}
        </div>
        ${opt.question_keywords && opt.question_keywords.length > 0 ? `<div style="margin: 1rem 0;"><strong>Question Keywords to Target:</strong><br>${opt.question_keywords.map(k => `<span class="badge badge-info" style="margin: 0.25rem;">${k}</span>`).join('')}</div>` : ''}
        ${opt.conversational_phrases && opt.conversational_phrases.length > 0 ? `<div style="margin: 1rem 0;"><strong>Conversational Phrases:</strong><br>${opt.conversational_phrases.map(p => `<span class="badge badge-secondary" style="margin: 0.25rem;">${p}</span>`).join('')}</div>` : ''}
        ${opt.optimization_tips && opt.optimization_tips.length > 0 ? `<h4 style="margin: 1rem 0 0.5rem;">Optimization Tips</h4><ul>${opt.optimization_tips.map(t => `<li>${t}</li>`).join('')}</ul>` : ''}
    `;
    }

    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => alert('Copied to clipboard!'));
    }


    // Add these functions to the <script> block in templates/modules/seo.html

    // ========== COMPETITOR HEATMAP FUNCTIONS ==========

    let competitorCount = 1;

    function addCompetitorInput() {
        if (competitorCount >= 5) {
            showNotification('Maximum 5 competitors allowed', 'warning');
            return;
        }

        competitorCount++;
        const container = document.getElementById('competitor-inputs');
        const inputGroup = document.createElement('div');
        inputGroup.className = 'competitor-input-group';
        inputGroup.innerHTML = `
        <input type="url" class="form-control competitor-url" placeholder="https://competitor${competitorCount}.com">
        <button class="btn-icon-remove" onclick="removeCompetitorInput(this)">
            <i class="ti ti-x"></i>
        </button>
    `;
        container.appendChild(inputGroup);

        // Update first input to show remove button
        if (competitorCount > 1) {
            document.querySelectorAll('.btn-icon-remove').forEach(btn => {
                btn.style.display = 'flex';
            });
        }

        // Disable add button if at max
        if (competitorCount >= 5) {
            document.getElementById('add-competitor-btn').disabled = true;
        }
    }

    function removeCompetitorInput(button) {
        button.closest('.competitor-input-group').remove();
        competitorCount--;

        // Enable add button
        document.getElementById('add-competitor-btn').disabled = false;

        // Hide remove buttons if only one input remains
        if (competitorCount === 1) {
            document.querySelectorAll('.btn-icon-remove').forEach(btn => {
                btn.style.display = 'none';
            });
        }
    }

    function clearHeatmapResults() {
        document.getElementById('heatmap-results').style.display = 'none';
    }

    async function generateHeatmap() {
        const projectId = document.getElementById('heatmap-project').value;

        if (!projectId) {
            showNotification('Please select an SEO project', 'error');
            return;
        }

        // Get all competitor URLs
        const competitorInputs = document.querySelectorAll('.competitor-url');
        const competitorUrls = Array.from(competitorInputs)
            .map(input => input.value.trim())
            .filter(url => url !== '');

        if (competitorUrls.length === 0) {
            showNotification('Please enter at least one competitor URL', 'error');
            return;
        }

        // Validate URLs
        const urlPattern = /^https?:\/\/.+/;
        const invalidUrls = competitorUrls.filter(url => !urlPattern.test(url));
        if (invalidUrls.length > 0) {
            showNotification('Please enter valid URLs starting with http:// or https://', 'error');
            return;
        }

        try {
            // Show loading
            showNotification('Analyzing competitors... This may take a moment.', 'info');

            const response = await fetch(`${API_BASE}/competitor-heatmap`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    seo_project_id: parseInt(projectId),
                    competitor_urls: competitorUrls
                })
            });

            const data = await response.json();

            if (response.ok && data.success) {
                displayHeatmapResults(data);
                showNotification('Competitor analysis completed successfully', 'success');
            } else {
                throw new Error(data.detail || 'Failed to generate heatmap');
            }

        } catch (error) {
            console.error('Error generating heatmap:', error);
            showNotification(error.message || 'Failed to generate competitor heatmap', 'error');
        }
    }

    function displayHeatmapResults(data) {
        // Show results section
        document.getElementById('heatmap-results').style.display = 'block';

        // 1. Display Gap Analysis Summary
        displayGapsSummary(data.gaps_analysis);

        // 2. Display Visual Heatmap
        displayVisualHeatmap(data.comparison_data, data.max_values);

        // 3. Display Detailed Metrics Table
        displayMetricsTable(data.comparison_data);

        // Scroll to results
        document.getElementById('heatmap-results').scrollIntoView({ behavior: 'smooth' });
    }

    function displayGapsSummary(gaps) {
        const container = document.getElementById('gaps-summary');

        const metricsLabels = {
            domain_authority: 'Domain Authority',
            page_authority: 'Page Authority',
            spam_score: 'Spam Score',
            total_backlinks: 'Total Backlinks',
            referring_domains: 'Referring Domains'
        };

        let html = '<div class="gaps-summary">';

        for (const [metric, data] of Object.entries(gaps)) {
            const isWinning = data.is_winning;
            const cardClass = isWinning ? 'winning' : (data.gap === 0 ? 'neutral' : 'losing');
            const statusBadge = isWinning ? 'winning' : (data.gap === 0 ? 'neutral' : 'losing');
            const statusText = isWinning ? 'Leading' : (data.gap === 0 ? 'On Par' : 'Gap Identified');

            html += `
            <div class="gap-card ${cardClass}">
                <div class="gap-metric-name">${metricsLabels[metric]}</div>
                <div class="gap-values">
                    <span class="gap-your-value">${data.client_value}</span>
                    <span class="gap-best-value">vs ${data.max_competitor_value}</span>
                </div>
                <div class="gap-opportunity">${data.opportunity}</div>
                <span class="gap-status-badge ${statusBadge}">${statusText}</span>
            </div>
        `;
        }

        html += '</div>';
        container.innerHTML = html;
    }

    function displayVisualHeatmap(comparisonData, maxValues) {
        const container = document.getElementById('heatmap-visualization');

        const metrics = [
            { key: 'domain_authority', label: 'Domain Authority', max: 100 },
            { key: 'page_authority', label: 'Page Authority', max: 100 },
            { key: 'spam_score', label: 'Spam Score', max: 100, inverse: true },
            { key: 'total_backlinks', label: 'Total Backlinks', max: maxValues.total_backlinks },
            { key: 'referring_domains', label: 'Referring Domains', max: maxValues.referring_domains }
        ];

        // Build heatmap grid
        let html = '<div class="heatmap-grid" style="grid-template-columns: 200px repeat(' + comparisonData.length + ', 1fr);">';

        // Header row
        html += '<div class="heatmap-row" style="grid-template-columns: subgrid; grid-column: span ' + (comparisonData.length + 1) + ';">';
        html += '<div class="heatmap-cell header">Metric</div>';

        comparisonData.forEach(site => {
            const isClient = site.is_client;
            html += `<div class="heatmap-cell header ${isClient ? 'client-column' : ''}">${site.name}</div>`;
        });
        html += '</div>';

        // Metric rows
        metrics.forEach(metric => {
            html += '<div class="heatmap-row" style="grid-template-columns: subgrid; grid-column: span ' + (comparisonData.length + 1) + ';">';
            html += `<div class="heatmap-cell metric-name">${metric.label}</div>`;

            comparisonData.forEach(site => {
                const isClient = site.is_client;

                if (site.error) {
                    html += `<div class="heatmap-cell error ${isClient ? 'client-column' : ''}">Error</div>`;
                    return;
                }

                const value = site[metric.key] || 0;
                const cellClass = getHeatmapCellClass(value, metric.max, metric.inverse);

                html += `
                <div class="heatmap-cell ${cellClass} ${isClient ? 'client-column' : ''}">
                    <span class="metric-value">${value}</span>
                </div>
            `;
            });

            html += '</div>';
        });

        html += '</div>';
        container.innerHTML = html;
    }

    function getHeatmapCellClass(value, max, inverse = false) {
        const percentage = max > 0 ? (value / max) * 100 : 0;

        if (inverse) {
            // For metrics where lower is better (e.g., spam score)
            if (percentage <= 25) return 'excellent';
            if (percentage <= 50) return 'good';
            if (percentage <= 75) return 'warning';
            return 'danger';
        } else {
            // For metrics where higher is better
            if (percentage >= 75) return 'excellent';
            if (percentage >= 50) return 'good';
            if (percentage >= 25) return 'warning';
            return 'danger';
        }
    }

    function displayMetricsTable(comparisonData) {
        const tableHead = document.querySelector('#metrics-table thead tr');
        const tableBody = document.getElementById('metrics-table-body');

        // Clear existing competitor columns
        while (tableHead.children.length > 2) {
            tableHead.removeChild(tableHead.lastChild);
        }

        // Add competitor columns to header
        comparisonData.forEach(site => {
            if (!site.is_client) {
                const th = document.createElement('th');
                th.textContent = site.name;
                tableHead.appendChild(th);
            }
        });

        // Build table rows
        const metrics = [
            { key: 'domain_authority', label: 'Domain Authority' },
            { key: 'page_authority', label: 'Page Authority' },
            { key: 'spam_score', label: 'Spam Score' },
            { key: 'total_backlinks', label: 'Total Backlinks' },
            { key: 'referring_domains', label: 'Referring Domains' }
        ];

        let html = '';

        metrics.forEach(metric => {
            html += '<tr>';
            html += `<td class="metric-name-cell">${metric.label}</td>`;

            comparisonData.forEach(site => {
                const isClient = site.is_client;
                const value = site.error ? 'Error' : (site[metric.key] || 0);
                const valueClass = site.error ? '' : getValueClass(metric.key, value);

                html += `<td class="${isClient ? 'client-value' : ''} ${valueClass}">${value}</td>`;
            });

            html += '</tr>';
        });

        tableBody.innerHTML = html;
    }

    function getValueClass(metricKey, value) {
        if (metricKey === 'domain_authority' || metricKey === 'page_authority') {
            if (value >= 70) return 'value-excellent';
            if (value >= 50) return 'value-good';
            if (value >= 30) return 'value-warning';
            return 'value-danger';
        }

        if (metricKey === 'spam_score') {
            if (value <= 5) return 'value-excellent';
            if (value <= 15) return 'value-good';
            if (value <= 30) return 'value-warning';
            return 'value-danger';
        }

        return '';
    }

    function populateProjectSelects(projects) {
        const selects = [
            'audit-project',
            'keyword-project',
            'backlink-project',
            'backlink-suggest-project',
            'heatmap-project',
            'reports-project'  //  MAKE SURE THIS LINE IS HERE
        ];

        selects.forEach(selectId => {
            const select = document.getElementById(selectId);
            if (select) {
                select.innerHTML = '<option value="">Select a project...</option>';
                projects.forEach(p => {
                    const option = document.createElement('option');
                    option.value = p.seo_project_id;
                    option.textContent = p.website_url;
                    select.appendChild(option);
                });
            }
        });
    }


    // Update the switchTab function to include competitor tab
    function switchTab(tabName) {
        document.querySelectorAll('.seo-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.seo-tab-content').forEach(c => c.classList.remove('active'));

        const tabIndex = getTabIndex(tabName);
        document.querySelector(`.seo-tab:nth-child(${tabIndex})`).classList.add('active');
        document.getElementById(`${tabName}-tab`).classList.add('active');

        if (tabName === 'keywords') loadKeywordRankings();
        if (tabName === 'backlinks') loadBacklinkHistory();
        if (tabName === 'competitor') clearHeatmapResults();
    }

    function getTabIndex(name) {
        const tabs = ['projects', 'audit', 'competitor', 'keywords', 'backlinks', 'reports', 'optimization', 'voice'];
        return tabs.indexOf(name) + 1;
    }


    function showNotification(message, type = 'info') {
        const colors = {
            success: '#10B981',
            error: '#EF4444',
            info: '#3B82F6',
            warning: '#F59E0B'
        };

        const icons = {
            success: 'check-circle',
            error: 'alert-circle',
            info: 'info-circle',
            warning: 'alert-triangle'
        };

        const notification = document.createElement('div');
        notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${colors[type]};
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 12px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        z-index: 10000;
        animation: slideIn 0.3s ease;
        max-width: 400px;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    `;

        notification.innerHTML = `
        <i class="ti ti-${icons[type]}" style="font-size: 1.5rem;"></i>
        <span>${message}</span>
    `;

        document.body.appendChild(notification);

        setTimeout(() => {
            notification.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    }

</script>


<script>
    // Chart instances for cleanup
    let trafficChart = null;
    let clicksChart = null;
    let impressionsChart = null;

    // Sync Performance Data from Google Search Console
    async function syncPerformanceData() {
        const projectId = document.getElementById('reports-project').value;

        if (!projectId) {
            alert('Please select a project first');
            return;
        }

        try {
            showNotification('Syncing data from Google Search Console...', 'info');

            const response = await fetch(`${API_BASE}/reports/sync/${projectId}`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}` }
            });

            const data = await response.json();

            if (data.success) {
                showNotification(`Successfully synced ${data.records_synced} days of data`, 'success');
                loadMonthlyReport();
            } else {
                showNotification(data.detail || 'Failed to sync data', 'error');
            }
        } catch (error) {
            console.error('Error syncing performance data:', error);
            showNotification('Failed to sync data. Please check Google Search Console credentials.', 'error');
        }
    }

    // Load Monthly Report
    async function loadMonthlyReport() {
        const projectId = document.getElementById('reports-project').value;
        const months = document.getElementById('reports-months').value;

        if (!projectId) {
            document.getElementById('reports-summary').style.display = 'none';
            document.getElementById('reports-empty').style.display = 'block';
            return;
        }

        try {
            const response = await fetch(`${API_BASE}/reports/monthly/${projectId}?months=${months}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            const data = await response.json();

            if (data.success) {
                displayMonthlyReport(data);
            } else {
                showNotification('No data available. Please sync data first.', 'warning');
            }
        } catch (error) {
            console.error('Error loading monthly report:', error);
            showNotification('Failed to load report', 'error');
        }
    }

    // Display Monthly Report
    function displayMonthlyReport(data) {
        document.getElementById('reports-empty').style.display = 'none';
        document.getElementById('reports-summary').style.display = 'block';

        // Update summary cards
        document.getElementById('report-total-traffic').textContent = data.summary.total_traffic.toLocaleString();
        document.getElementById('report-total-impressions').textContent = data.summary.total_impressions.toLocaleString();
        document.getElementById('report-total-clicks').textContent = data.summary.total_clicks.toLocaleString();
        document.getElementById('report-avg-ctr').textContent = data.summary.average_ctr + '%';
        document.getElementById('report-avg-position').textContent = data.summary.average_position.toFixed(1);

        // Create Traffic Trend Chart
        createTrafficChart(data.monthly_data);

        // Create Clicks Chart
        createClicksChart(data.monthly_data);

        // Create Impressions Chart
        createImpressionsChart(data.monthly_data);

        // Populate daily data table
        displayDailyData(data.daily_data);
    }

    // Create Traffic Trend Chart
    function createTrafficChart(monthlyData) {
        const ctx = document.getElementById('traffic-chart').getContext('2d');

        // Destroy existing chart
        if (trafficChart) {
            trafficChart.destroy();
        }

        trafficChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: monthlyData.labels,
                datasets: [{
                    label: 'Traffic (Organic Clicks)',
                    data: monthlyData.traffic,
                    borderColor: '#9926F3',
                    backgroundColor: 'rgba(153, 38, 243, 0.1)',
                    tension: 0.4,
                    fill: true,
                    pointRadius: 5,
                    pointHoverRadius: 7
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 12,
                        titleFont: { size: 14 },
                        bodyFont: { size: 13 }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function (value) {
                                return value.toLocaleString();
                            }
                        }
                    }
                }
            }
        });
    }

    // Create Clicks Chart
    function createClicksChart(monthlyData) {
        const ctx = document.getElementById('clicks-chart').getContext('2d');

        if (clicksChart) {
            clicksChart.destroy();
        }

        clicksChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: monthlyData.labels,
                datasets: [{
                    label: 'Clicks',
                    data: monthlyData.clicks,
                    backgroundColor: '#1DD8FC',
                    borderRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function (value) {
                                return value.toLocaleString();
                            }
                        }
                    }
                }
            }
        });
    }

    // Create Impressions Chart
    function createImpressionsChart(monthlyData) {
        const ctx = document.getElementById('impressions-chart').getContext('2d');

        if (impressionsChart) {
            impressionsChart.destroy();
        }

        impressionsChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: monthlyData.labels,
                datasets: [{
                    label: 'Impressions',
                    data: monthlyData.impressions,
                    backgroundColor: '#9926F3',
                    borderRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function (value) {
                                return value.toLocaleString();
                            }
                        }
                    }
                }
            }
        });
    }

    // Display Daily Data Table
    function displayDailyData(dailyData) {
        const tbody = document.getElementById('daily-data-body');

        if (!dailyData || dailyData.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #6c757d;">No daily data available</td></tr>';
            return;
        }

        // Show last 30 days only
        const recentData = dailyData.slice(-30);

        tbody.innerHTML = recentData.reverse().map(row => `
        <tr>
            <td>${new Date(row.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</td>
            <td><strong>${row.clicks.toLocaleString()}</strong></td>
            <td>${row.impressions.toLocaleString()}</td>
            <td>${row.ctr.toFixed(2)}%</td>
            <td>${row.position.toFixed(1)}</td>
        </tr>
    `).join('');
    }

    // Export Report
    async function exportReport() {
        const projectId = document.getElementById('reports-project').value;
        const months = document.getElementById('reports-months').value;

        if (!projectId) {
            alert('Please select a project first');
            return;
        }

        try {
            const response = await fetch(`${API_BASE}/reports/export/${projectId}?format=json&months=${months}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            const data = await response.json();

            // Create downloadable JSON file
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `seo-report-${projectId}-${new Date().toISOString().split('T')[0]}.json`;
            link.click();

            showNotification('Report exported successfully', 'success');
        } catch (error) {
            console.error('Error exporting report:', error);
            showNotification('Failed to export report', 'error');
        }
    }

</script>


{% endblock %}